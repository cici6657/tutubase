<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>章鱼喷墨机</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/kGYP6CQw/6.png">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        /* --- 全局与主题样式 --- */
        :root {
            --bg-color: #fce4ec;
            --primary-color: #ff80ab;
            --secondary-color: #f48fb1;
            --accent-color: #90caf9;
            --text-color: #444;
            --white-color: #fff;
            --border-radius: 18px;
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            --top-pinned-bg: #fff0f5;
            --online-status-color: #4CAF50;
        }

        /* 自动深色模式支持 */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #1a1a1a;
                --text-color: #e0e0e0;
                --white-color: #2d2d2d;
                --top-pinned-bg: #3a3a3a;
            }
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, var(--bg-color), var(--primary-color));
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            height: 100dvh; /* 现代浏览器动态视口高度 */
            overflow: hidden;
        }

        /* 移动端适配 */
        @media screen and (max-width: 768px) {
            body {
                height: 100vh;
                height: 100dvh;
            }
        }

        .phone-screen {
            width: 100%;
            height: 100%;
            max-width: 100vw;
            max-height: 100vh;
            max-height: 100dvh;
            background-color: var(--white-color);
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* 桌面端限制最大宽度 */
        @media screen and (min-width: 769px) {
            .phone-screen {
                max-width: 420px;
                max-height: 850px;
                border-radius: 20px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            }
        }

        .screen {
            display: none;
            flex-direction: column;
            width: 100%;
            height: 100%;
            animation: fadeIn 0.5s ease;
        }

        .screen.active {
            display: flex;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #eee;
            flex-shrink: 0;
            position: relative;
            z-index: 10;
            min-height: 60px;
        }

        .app-header .back-btn,
        .app-header .action-btn {
            background: none;
            border: none;
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #cancel-multi-select-btn {
            font-size: 14px !important;
            font-weight: 500 !important;
            color: var(--white-color) !important;
            background-color: var(--primary-color) !important;
            border-radius: 10px !important;
            padding: 5px 10px !important;
            width: auto !important;
            height: auto !important;
        }

        .app-header .action-btn-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .app-header .action-btn-group .action-btn {
            font-size: 16px;
            font-weight: 600;
            width: auto;
            padding: 6px 12px;
            border-radius: 10px;
        }

        .app-header .action-btn-group #create-group-btn {
            background-color: var(--primary-color);
            color: var(--white-color);
        }

        .app-header .action-btn-group #add-chat-btn {
            font-size: 28px;
            padding: 0;
            width: 40px;
            height: 40px;
            background-color: transparent;
            color: var(--primary-color);
            border-radius: 50%;
        }

        .app-header .action-btn img {
            width: 28px;
            height: 28px;
        }

        .app-header .title-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        .app-header .title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color);
            margin: 0;
        }

        .app-header .subtitle {
            font-size: 12px;
            color: #888;
            display: flex;
            align-items: center;
            margin-top: 2px;
        }

        .online-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--online-status-color);
            margin-right: 5px;
        }

        .app-header .placeholder {
            width: 40px;
        }

        /* 搜索框样式 */
        .search-container {
            padding: 10px 20px;
            background-color: rgba(255, 255, 255, 0.9);
            border-bottom: 1px solid #eee;
        }

        .search-input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            background-color: #f5f5f5;
            font-size: 14px;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        /* 消息统计样式 */
        .chat-stats {
            padding: 5px 20px;
            background-color: rgba(248, 248, 248, 0.9);
            font-size: 12px;
            color: #666;
            border-bottom: 1px solid #eee;
        }

        #home-screen {
            justify-content: center;
            background-size: cover;
            background-position: center;
            transition: background-image 0.5s ease-in-out;
            padding: 40px 20px;
        }

        .time-widget {
            text-align: center;
            padding: 0 20px;
            color: var(--text-color);
            margin-bottom: 60px;
        }

        .time-widget .time {
            font-size: 64px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .time-widget .date {
            font-size: 16px;
            color: #666;
        }

        #home-screen.day-mode .time-widget,
        #home-screen.day-mode .time-widget .date,
        #home-screen.day-mode .app-icon .app-name {
            color: var(--white-color);
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
        }

        .app-grid {
            width: 100%;
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 30px;
            justify-content: center;
            align-content: center;
            max-width: 300px;
            margin: 0 auto;
        }

        .dock {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            margin: 40px 20px 20px;
            min-height: 80px;
            gap: 20px;
        }

        .app-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            text-decoration: none;
            transition: transform 0.2s ease;
        }

        .app-icon:hover {
            transform: translateY(-5px);
        }

        .icon-img {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            margin-bottom: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
            object-fit: cover;
        }

        .app-icon .app-name {
            font-size: 12px;
            color: var(--text-color);
            font-weight: 500;
            text-align: center;
        }

        .content {
            flex-grow: 1;
            overflow-y: auto;
            position: relative;
        }

        .placeholder-text {
            text-align: center;
            color: #aaa;
            margin-top: 50px;
        }

        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: 100;
            display: none;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal-window {
            background: var(--white-color);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.15);
            width: 85%;
            max-width: 340px;
            animation: slideUp 0.4s ease-out;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-window h3 {
            margin-top: 0;
            text-align: center;
            color: var(--primary-color);
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* 全屏设置面板样式 */
        .settings-fullscreen {
            position: fixed;
            top: 0;
            right: -100%;
            width: 100%;
            height: 100vh;
            height: 100dvh;
            background: var(--white-color);
            transition: right 0.4s ease-in-out;
            z-index: 200;
            display: flex;
            flex-direction: column;
        }

        .settings-fullscreen.open {
            right: 0;
        }

        .settings-fullscreen .settings-header {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            background-color: var(--primary-color);
            color: white;
            min-height: 60px;
        }

        .settings-fullscreen .settings-close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .settings-fullscreen .settings-title {
            flex-grow: 1;
            text-align: center;
            font-size: 18px;
            font-weight: 600;
        }

        .settings-fullscreen .settings-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .context-menu {
            position: fixed;
            z-index: 1000;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            padding: 5px 0;
            animation: fadeIn 0.1s ease;
        }

        .context-menu-item {
            padding: 10px 20px;
            cursor: pointer;
        }

        .context-menu-item:hover {
            background-color: #f5f5f5;
        }

        .context-menu-item.danger {
            color: #e53935;
        }

        .action-sheet-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: 200;
            display: none;
            align-items: flex-end;
            animation: fadeIn 0.3s ease;
        }

        .action-sheet-overlay.visible {
            display: flex;
        }

        .action-sheet {
            background: #f7f7f7;
            width: 100%;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            padding: 10px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            animation: slideUp 0.3s ease-out;
        }

        .action-sheet-button {
            width: 100%;
            background: white;
            border: none;
            padding: 15px;
            font-size: 16px;
            color: var(--primary-color);
            font-weight: 500;
            cursor: pointer;
            border-radius: 10px;
            margin-bottom: 8px;
        }

        .action-sheet-button.danger {
            color: #e53935;
        }

        .action-sheet-button:last-child {
            margin-bottom: 0;
        }

        #chat-list-screen .content,
        #world-book-screen .content {
            padding: 0;
        }

        .list-container {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .list-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s ease;
            position: relative;
        }

        .list-item:hover {
            background-color: #fdf6f8;
        }

        .chat-item.pinned {
            background-color: var(--top-pinned-bg);
        }

        .chat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
            flex-shrink: 0;
            background-color: #eee;
        }

        .group-avatar {
            border-radius: 10px;
        }

        .item-details {
            flex-grow: 1;
            overflow: hidden;
        }

        .item-details-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item-name {
            font-weight: 600;
            color: var(--text-color);
            font-size: 16px;
        }

        .item-preview-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
        }

        .item-preview {
            font-size: 14px;
            color: #888;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-grow: 1;
        }

        .pin-badge {
            background-color: var(--primary-color);
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 5px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        #chat-room-screen {
            background-size: cover;
            background-position: center;
        }

        #chat-room-screen .content {
            display: flex;
            flex-direction: column;
            padding: 10px;
            padding-bottom: 10px;
            transition: padding-bottom 0.3s ease;
        }

        #chat-room-screen.multi-select-active .content {
            padding-bottom: 70px;
        }

        .message-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: 0 10px;
            scroll-behavior: smooth;
        }

        /* 日期分隔符样式 */
        .date-separator {
            text-align: center;
            margin: 20px 0 10px;
            position: relative;
        }

        .date-separator-line {
            height: 1px;
            background: linear-gradient(to right, transparent, #ddd, transparent);
            margin: 0 20px;
        }

        .date-separator-text {
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--white-color);
            padding: 0 15px;
            font-size: 12px;
            color: #888;
        }

        .message-wrapper {
            display: flex;
            margin-bottom: 12px;
            align-items: flex-start;
            transition: background-color 0.2s;
            flex-direction: column;
        }

        .message-wrapper.group-message {
            margin-bottom: 18px;
        }

        .message-wrapper.sent {
            align-items: flex-end;
        }

        .message-wrapper.received {
            align-items: flex-start;
        }

        .message-wrapper.system-notification {
            align-items: center;
        }

        .message-bubble-row {
            display: flex;
            width: 100%;
            align-items: flex-start;
        }

        .message-wrapper.sent .message-bubble-row {
            flex-direction: row-reverse;
        }

        .message-wrapper.multi-select-selected {
            background-color: rgba(144, 202, 249, 0.2);
            border-radius: var(--border-radius);
        }

        /* 简洁气泡样式 - 无头像显示 */
        .message-info {
            display: none; /* 隐藏头像和时间 */
        }

        .message-bubble {
            max-width: 260px;
            padding: 12px 16px;
            border-radius: var(--border-radius);
            word-wrap: break-word;
            line-height: 1.4;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            margin: 0 8px;
            cursor: pointer;
            font-size: 15px;
            position: relative;
        }

        /* 添加时间戳到气泡底部 */
        .message-bubble::after {
            content: attr(data-time);
            position: absolute;
            bottom: -15px;
            right: 0;
            font-size: 10px;
            color: #aaa;
        }

        .message-wrapper.received .message-bubble::after {
            left: 0;
            right: auto;
        }

        .message-bubble.sent {
            border-bottom-right-radius: 5px;
            background-color: rgba(255, 204, 204, 0.9);
            color: #A56767;
        }

        .message-bubble.received {
            border-bottom-left-radius: 5px;
            background-color: rgba(255, 255, 255, 0.9);
            color: #6D6D6D;
        }

        .system-notification-bubble {
            background-color: rgba(200, 200, 200, 0.5);
            color: #666;
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 10px;
            text-align: center;
        }

        .image-bubble {
            max-width: 120px;
            border-radius: var(--border-radius);
            margin: 0 8px;
            padding: 4px;
            background-color: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            cursor: pointer;
        }

        .image-bubble img {
            width: 100%;
            height: auto;
            display: block;
            border-radius: calc(var(--border-radius) - 4px);
        }

        .message-wrapper.sent .image-bubble {
            border-bottom-right-radius: 5px;
        }

        .message-wrapper.received .image-bubble {
            border-bottom-left-radius: 5px;
        }

        .voice-bubble {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            border-radius: var(--border-radius);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            margin: 0 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 90px;
            max-width: 200px;
        }

        .message-wrapper.sent .voice-bubble {
            border-bottom-right-radius: 5px;
            flex-direction: row-reverse;
        }

        .message-wrapper.received .voice-bubble {
            border-bottom-left-radius: 5px;
        }

        .voice-bubble .play-icon {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }

        .voice-bubble .duration {
            font-size: 13px;
            margin: 0 8px;
            white-space: nowrap;
        }

        .message-wrapper.sent .play-icon {
            transform: scaleX(-1);
        }

        .voice-transcript {
            font-size: 14px;
            color: #555;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 8px 12px;
            margin-top: 5px;
            margin-left: 54px;
            margin-right: 54px;
            border-radius: 10px;
            line-height: 1.6;
            max-width: calc(100% - 108px);
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .voice-transcript.active {
            display: block;
        }

        .message-wrapper.sent .voice-transcript {
            align-self: flex-end;
            margin-right: 54px;
            margin-left: auto;
        }

        .message-wrapper.received .voice-transcript {
            align-self: flex-start;
            margin-left: 54px;
            margin-right: auto;
        }

        .pv-card {
            width: 230px;
            aspect-ratio: 1 / 1;
            background-color: #f0f0f0;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            position: relative;
            cursor: pointer;
            margin: 0 8px;
        }

        .message-wrapper.sent .pv-card {
            border-bottom-right-radius: 5px;
        }

        .message-wrapper.received .pv-card {
            border-bottom-left-radius: 5px;
        }

        .pv-card-image-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            transition: opacity 0.5s ease-in-out;
            z-index: 2;
        }

        .pv-card-image-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .pv-card-content {
            padding: 15px;
            height: 100%;
            overflow-y: auto;
            color: var(--text-color);
            line-height: 1.6;
            font-size: 15px;
            background-color: white;
            position: relative;
            z-index: 1;
        }

        .pv-card-footer {
            background: linear-gradient(to top, rgba(0, 0, 0, 0.6), transparent);
            color: white;
            padding: 20px 10px 8px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 3;
            pointer-events: none;
            transition: opacity 0.5s ease-in-out;
        }

        .pv-card-footer.hidden {
            opacity: 0;
        }

        .pv-card-footer svg {
            width: 14px;
            height: 14px;
            fill: white;
            flex-shrink: 0;
        }

        .transfer-card {
            width: 240px;
            height: auto;
            border-radius: var(--border-radius);
            margin: 0 8px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            color: white;
        }

        .message-wrapper.sent .transfer-card {
            border-bottom-right-radius: 5px;
        }

        .message-wrapper.received .transfer-card {
            border-bottom-left-radius: 5px;
            cursor: pointer;
        }

        .transfer-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-size: cover;
            background-position: center;
            filter: blur(4px);
            transform: scale(1.1);
            z-index: 1;
        }

        .transfer-card.sent-transfer::before {
            background-image: url('https://i.postimg.cc/sxN893WF/IMG-20250712.png');
        }

        .transfer-card.received-transfer::before {
            background-image: url('https://i.postimg.cc/FzR8LY7g/IMG-20250712-170703.png');
        }

        .transfer-card .overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.3);
            z-index: 2;
            transition: background-color 0.5s ease;
        }

        .transfer-card.received .overlay {
            background-color: rgba(255, 182, 193, 0.4);
        }

        .transfer-card.returned .overlay {
            background-color: rgba(100, 100, 100, 0.5);
        }

        .transfer-content {
            position: relative;
            z-index: 3;
            padding: 20px;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        }

        .transfer-title {
            font-size: 14px;
            margin: 0 0 5px 0;
            opacity: 0.9;
        }

        .transfer-amount {
            font-size: 28px;
            font-weight: bold;
            margin: 0;
        }

        .transfer-remark {
            font-size: 14px;
            margin-top: 10px;
            opacity: 0.9;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .transfer-status {
            font-size: 12px;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            opacity: 0.8;
        }

        .gift-card {
            width: 230px;
            background-color: #fff;
            border: 2px solid #333;
            border-radius: var(--border-radius);
            box-shadow: 4px 4px 0px #ddd;
            padding: 10px;
            display: flex;
            align-items: center;
            cursor: pointer;
            margin: 0 8px;
            position: relative;
            overflow: hidden;
        }

        .message-wrapper.sent .gift-card {
            border-bottom-right-radius: 5px;
        }

        .message-wrapper.received .gift-card {
            border-bottom-left-radius: 5px;
        }

        .gift-card-icon {
            width: 50px;
            height: 50px;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .gift-card-text {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            font-family: 'Comic Sans MS', 'Chalkduster', 'Handwriting', cursive;
        }

        .gift-card-description {
            font-size: 14px;
            color: #555;
            background-color: rgba(240, 240, 240, 0.9);
            padding: 8px 12px;
            margin-top: 5px;
            margin-left: 54px;
            margin-right: 54px;
            border-radius: 10px;
            line-height: 1.6;
            max-width: calc(100% - 108px);
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .gift-card-description.active {
            display: block;
        }

        .message-wrapper.sent .gift-card-description {
            align-self: flex-end;
            margin-right: 54px;
            margin-left: auto;
        }

        .message-wrapper.received .gift-card-description {
            align-self: flex-start;
            margin-left: 54px;
            margin-right: auto;
        }

        .gift-card-received-stamp {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 14px;
            font-weight: bold;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            padding: 2px 6px;
            transform: rotate(15deg);
            opacity: 0;
            transition: opacity 0.3s ease;
            font-family: 'Comic Sans MS', 'Chalkduster', 'Handwriting', cursive;
        }

        .gift-card.received .gift-card-received-stamp {
            opacity: 1;
        }

        .load-more-btn {
            background-color: #e0e0e0;
            color: #757575;
            border: none;
            padding: 8px 16px;
            margin: 10px auto;
            border-radius: 15px;
            cursor: pointer;
            display: block;
            font-size: 13px;
            font-weight: 500;
        }

        .load-more-btn:hover {
            background-color: #d1d1d1;
        }

        .typing-indicator {
            text-align: center;
            color: #aaa;
            font-style: italic;
            font-size: 14px;
            padding: 10px 0;
            display: none;
        }

        #sticker-bar {
            flex-shrink: 0;
            padding: 0 10px 5px;
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
        }

        .sticker-bar-btn {
            background: none;
            border: none;
            padding: 5px;
            cursor: pointer;
        }

        .sticker-bar-btn svg {
            width: 28px;
            height: 28px;
            fill: #888;
        }

        #sticker-modal {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 35%;
            max-height: 250px;
            background: #f7f7f7;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.1);
            z-index: 25;
            display: none;
            flex-direction: column;
        }

        #sticker-modal.visible {
            display: flex;
            animation: slideUp 0.3s ease-out;
        }

        #sticker-modal .header {
            padding: 10px 15px;
            font-weight: bold;
            color: var(--text-color);
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sticker-grid {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 15px;
        }

        .sticker-item {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }

        .sticker-item img {
            width: 60px;
            height: 60px;
            object-fit: contain;
        }

        .sticker-item span {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            text-align: center;
        }

        #add-sticker-modal .modal-window {
            max-width: 360px;
        }

        #sticker-preview {
            width: 100px;
            height: 100px;
            border: 2px dashed #ddd;
            border-radius: 10px;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #aaa;
            background-color: #f9f9f9;
        }

        #sticker-preview img {
            max-width: 100%;
            max-height: 100%;
        }

        .chat-input-wrapper {
            flex-shrink: 0;
        }

        .message-input-area {
            display: flex;
            align-items: center;
            padding: 10px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            border-top: 1px solid #eee;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            flex-shrink: 0;
            gap: 10px;
            overflow: hidden;
        }

        .message-input-area input {
            flex-grow: 1;
            border: none;
            padding: 12px;
            border-radius: 18px;
            background-color: #f0f0f0;
        }

        .message-input-area input:focus {
            outline: none;
        }

        .message-input-area .icon-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        .message-input-area .icon-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .message-input-area .icon-btn svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        .message-input-area .icon-btn.send-btn {
            font-size: 18px;
        }

        #multi-select-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            border-top: 1px solid #eee;
            z-index: 20;
            animation: slideUp 0.3s ease-out;
        }

        #multi-select-bar.visible {
            display: flex;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--secondary-color);
            font-weight: 600;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #fce4ec;
            border-radius: 10px;
            background-color: #fff;
            transition: border-color 0.3s;
            font-family: var(--font-family);
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .form-group.radio-group {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .form-group.radio-group label {
            margin-bottom: 0;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border-radius: 10px;
            border: none;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-align: center;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: var(--white-color);
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
            box-shadow: 0 4px 15px rgba(255, 128, 171, 0.5);
        }

        label.btn-primary {
            color: var(--white-color) !important;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
            width: auto;
        }

        .btn-secondary {
            background-color: var(--accent-color);
            color: var(--white-color);
            margin-bottom: 15px;
        }

        .btn-secondary:hover {
            background-color: #64b5f6;
            box-shadow: 0 4px 15px rgba(144, 202, 249, 0.5);
        }

        .btn-neutral {
            background-color: #bdbdbd;
            color: var(--white-color);
        }

        .btn-neutral:hover {
            background-color: #9e9e9e;
        }

        .btn-danger {
            background-color: #ef5350;
            color: white;
        }

        .btn .spinner {
            display: none;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-top-color: var(--white-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .btn.loading .spinner {
            display: block;
        }

        .btn.loading .btn-text {
            display: none;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .wallpaper-preview {
            width: 100%;
            aspect-ratio: 9 / 16;
            max-height: 400px;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            background-size: cover;
            background-position: center;
            border: 3px dashed var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--secondary-color);
            font-style: italic;
            background-color: #fff8fa;
        }

        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 15px;
            font-size: 14px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s, visibility 0.5s;
            z-index: 1000;
        }

        .toast.show {
            opacity: 1;
            visibility: visible;
        }

        /* API 管理器样式 */
        .api-list {
            margin-bottom: 20px;
        }

        .api-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            border: 2px solid #fce4ec;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .api-item.active {
            border-color: var(--primary-color);
            background-color: rgba(255, 128, 171, 0.1);
        }

        .api-item-info {
            flex-grow: 1;
        }

        .api-item-name {
            font-weight: 600;
            color: var(--text-color);
        }

        .api-item-model {
            font-size: 12px;
            color: #888;
        }

        .api-item-actions {
            display: flex;
            gap: 10px;
        }

        .api-item-btn {
            padding: 5px 10px;
            font-size: 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .api-item-btn.edit {
            background-color: var(--accent-color);
            color: white;
        }

        .api-item-btn.delete {
            background-color: #ef5350;
            color: white;
        }

        /* 世界书优先级样式 */
        .world-book-priority {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .priority-badge {
            background-color: var(--primary-color);
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 30px;
            text-align: center;
        }

        /* 全局CSS编辑器样式 */
        .css-editor {
            position: relative;
        }

        .css-editor textarea {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            height: 200px;
            resize: vertical;
        }

        /* 响应式调整 */
        @media screen and (max-width: 480px) {
            .app-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 20px;
            }
            
            .time-widget .time {
                font-size: 48px;
            }
            
            .dock {
                gap: 15px;
            }
            
            .icon-img {
                width: 50px;
                height: 50px;
            }
        }

        /* 滚动条样式 */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3);
        }
    </style>
</head>

<body>
    <div class="phone-screen">
        <!-- 主屏幕 -->
        <div id="home-screen" class="screen active">
            <div class="time-widget">
                <div class="time" id="time-display"></div>
                <div class="date" id="date-display"></div>
            </div>
            <div class="app-grid">
                <a href="#" class="app-icon" data-target="chat-list-screen">
                    <img src="https://i.postimg.cc/VvQB8dQT/chan-143.png" alt="404" class="icon-img">
                    <span class="app-name">404</span>
                </a>
                <a href="#" class="app-icon" data-target="api-settings-screen">
                    <img src="https://i.postimg.cc/50FqT8GL/chan-125.png" alt="API" class="icon-img">
                    <span class="app-name">API</span>
                </a>
                <a href="#" class="app-icon" data-target="wallpaper-screen">
                    <img src="https://i.postimg.cc/3wqFttL3/chan-90.png" alt="壁纸" class="icon-img">
                    <span class="app-name">壁纸</span>
                </a>
                <a href="#" class="app-icon" data-target="world-book-screen">
                    <img src="https://i.postimg.cc/prCWkrKT/chan-74.png" alt="世界书" class="icon-img">
                    <span class="app-name">世界书</span>
                </a>
                <a href="#" class="app-icon" data-target="customize-screen">
                    <img src="https://i.postimg.cc/vZVdC7gt/chan-133.png" alt="自定义" class="icon-img">
                    <span class="app-name">自定义</span>
                </a>
                <a href="#" class="app-icon" data-target="font-settings-screen">
                    <img src="https://i.postimg.cc/FzVtC0x4/chan-21.png" alt="字体" class="icon-img">
                    <span class="app-name">字体</span>
                </a>
            </div>
            <div class="dock">
                <a href="#" class="app-icon" id="day-mode-btn">
                    <img src="https://i.postimg.cc/Jz0tYqnT/chan-145.png" alt="日间" class="icon-img">
                </a>
                <a href="#" class="app-icon" id="night-mode-btn">
                    <img src="https://i.postimg.cc/htYvkdQK/chan-146.png" alt="夜间" class="icon-img">
                </a>
            </div>
        </div>

        <!-- 聊天列表屏幕 -->
        <div id="chat-list-screen" class="screen">
            <header class="app-header">
                <button class="back-btn" data-target="home-screen">‹</button>
                <div class="title-container">
                    <h1 class="title">聊天</h1>
                </div>
                <div class="action-btn-group">
                    <button class="action-btn" id="create-group-btn">群聊</button>
                    <button class="action-btn" id="add-chat-btn">+</button>
                </div>
            </header>
            <!-- 搜索框 -->
            <div class="search-container">
                <input type="text" class="search-input" id="chat-search-input" placeholder="搜索聊天...">
            </div>
            <!-- 消息统计 -->
            <div class="chat-stats" id="chat-stats">
                总计：0 个聊天，0 条消息
            </div>
            <main class="content">
                <ul class="list-container" id="chat-list-container"></ul>
                <div class="placeholder-text" id="no-chats-placeholder" style="display: none;">
                    <p>还没有聊天对象哦~</p>
                    <p>点击右上角的"+"创建一个吧！</p>
                </div>
            </main>
        </div>

        <!-- 聊天室屏幕 -->
        <div id="chat-room-screen" class="screen">
            <header class="app-header" id="chat-room-header-default">
                <button class="back-btn" data-target="chat-list-screen">‹</button>
                <div class="title-container">
                    <h1 class="title" id="chat-room-title">...</h1>
                    <div class="subtitle" id="chat-room-subtitle">
                        <div class="online-indicator"></div><span id="chat-room-status-text">在线</span>
                    </div>
                </div>
                <button class="action-btn" id="chat-settings-btn"><img src="https://i.postimg.cc/nhwP4pQy/chan-73.png" alt="设置"></button>
            </header>
            <!-- 单窗口数据统计 -->
            <div class="chat-stats" id="chat-room-stats" style="display: none;">
                当前聊天：0 条消息，0 字符，0 次AI回复
            </div>
            <header class="app-header" id="chat-room-header-select" style="display: none;">
                <button class="action-btn" id="cancel-multi-select-btn">取消</button>
                <div class="title-container">
                    <h1 class="title" id="multi-select-title">选择消息</h1>
                </div>
                <div class="placeholder"></div>
            </header>
            <main class="content">
                <div class="message-area" id="message-area"></div>
                <div class="typing-indicator" id="typing-indicator"></div>
            </main>
            <div class="chat-input-wrapper">
                <div id="sticker-bar">
                    <button class="sticker-bar-btn" id="sticker-toggle-btn">
                        <svg viewBox="0 0 24 24">
                            <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z" /></svg>
                    </button>
                    <button class="sticker-bar-btn" id="photo-video-btn">
                        <svg viewBox="0 0 24 24">
                            <path d="M4,4H7L9,2H15L17,4H20A2,2 0 0,1 22,6V18A2,2 0 0,1 20,20H4A2,2 0 0,1 2,18V6A2,2 0 0,1 4,4M12,7A5,5 0 0,0 7,12A5,5 0 0,0 12,17A5,5 0 0,0 17,12A5,5 0 0,0 12,7M12,9A3,3 0 0,1 15,12A3,3 0 0,1 12,15A3,3 0 0,1 9,12A3,3 0 0,1 12,9Z" /></svg>
                    </button>
                    <button class="sticker-bar-btn" id="image-recognition-btn">
                        <svg viewBox="0 0 24 24">
                            <path d="M21.58,16.09L19.66,18L18.24,16.58L21,13.83C21.39,13.44 22,13.44 22.39,13.83L23.17,14.61C23.56,15 23.56,15.64 23.17,16.03L21.58,17.62M20.13,12.25L18.71,13.66L20.41,15.36L21.83,13.94L20.13,12.25M5.93,19H5C3.9,19 3,18.1 3,17V5C3,3.9 3.9,3 5,3H19C20.1,3 21,3.9 21,5V11.08L19,13.08V5H5V17H5.93L13.5,9.43L16.29,12.21L12.08,16.42L5.93,19Z" /></svg>
                    </button>
                    <button class="sticker-bar-btn" id="voice-message-btn">
                        <svg viewBox="0 0 24 24">
                            <path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z" /></svg>
                    </button>
                    <button class="sticker-bar-btn" id="wallet-btn">
                        <svg viewBox="0 0 24 24">
                            <path d="M20 4H4C2.9 4 2 4.9 2 6V18C2 19.1 2.9 20 4 20H20C21.1 20 22 19.1 22 18V6C22 4.9 21.1 4 20 4ZM20 18H4V8H20V18ZM4 6H20V6H4Z" /></svg>
                    </button>
                    <button class="sticker-bar-btn" id="gift-btn">
                        <svg viewBox="0 0 24 24">
                            <path d="M20,8L12,13L4,8V6H20M20,4H4A2,2 0 0,0 2,6V18A2,2 0 0,0 4,20H20A2,2 0 0,0 22,18V6A2,2 0 0,0 20,4M12.5,18C12.5,17.29 12.17,16.65 11.64,16.27C12.17,15.89 12.5,15.26 12.5,14.55C12.5,13.6 11.83,12.79 11,12.58V12H13V10H11V8H13V6H11V5C11,4.45 10.55,4 10,4H8C7.45,4 7,4.45 7,5V6H9V8H7V10H9V12H7V12.58C6.17,12.79 5.5,13.6 5.5,14.55C5.5,15.26 5.83,15.89 6.36,16.27C5.83,16.65 5.5,17.29 5.5,18H12.5Z" /></svg>
                    </button>
                    <button class="sticker-bar-btn" id="time-skip-btn">
                        <svg viewBox="0 0 24 24">
                           <path d="M4 5v14l7-7-7-7zm9 0v14l7-7-7-7z"></path></svg>
                    </button>
                </div>
                <div class="message-input-area" id="message-input-default">
                    <input type="text" id="message-input" placeholder="输入消息...">
                    <button id="send-message-btn" class="icon-btn send-btn">➤</button>
                    <button id="get-reply-btn" class="icon-btn">
                        <svg viewBox="0 0 24 24">
                            <path d="M12,2A10,10 0 1,0 22,12A10,10 0 0,0 12,2M12,20A8,8 0 1,1 20,12A8,8 0 0,1 12,20M16.24,7.76C15.07,6.58 13.53,6 12,6V12L7.76,16.24C10.1,18.58 13.9,18.58 16.24,16.24C18.58,13.9 18.58,10.1 16.24,7.76Z" /></svg>
                    </button>
                </div>
                <div class="message-input-area" id="message-edit-bar" style="display: none;">
                    <input type="text" id="message-edit-input">
                    <button id="save-edit-btn" class="icon-btn send-btn">✓</button>
                    <button id="cancel-edit-btn" class="icon-btn" style="background-color: #aaa;">✗</button>
                </div>
            </div>
            <div id="multi-select-bar">
                <span id="select-count">已选择 0 项</span>
                <button class="btn btn-danger" id="delete-selected-btn" style="width: auto; padding: 8px 16px;">删除已选</button>
            </div>
            <div id="sticker-modal">
                <div class="header">
                    <span>我的表情</span>
                    <button class="btn btn-primary btn-small" id="add-new-sticker-btn">添加新表情</button>
                </div>
                <div class="sticker-grid" id="sticker-grid-container"></div>
            </div>
        </div>

        <!-- 世界书屏幕 -->
        <div id="world-book-screen" class="screen">
            <header class="app-header">
                <button class="back-btn" data-target="home-screen">‹</button>
                <div class="title-container">
                    <h1 class="title">世界书</h1>
                </div>
                <button class="action-btn" id="add-world-book-btn">+</button>
            </header>
            <main class="content">
                <ul class="list-container" id="world-book-list-container"></ul>
                <div class="placeholder-text" id="no-world-books-placeholder" style="display: none;">
                    <p>你的世界一片混沌...</p>
                    <p>点击右上角的"+"创造第一个设定吧！</p>
                </div>
            </main>
        </div>

        <!-- 编辑世界书屏幕 -->
        <div id="edit-world-book-screen" class="screen">
            <header class="app-header">
                <button class="back-btn" data-target="world-book-screen">‹</button>
                <div class="title-container">
                    <h1 class="title" id="edit-world-book-title">创建/编辑条目</h1>
                </div>
                <div class="placeholder"></div>
            </header>
            <main class="content" style="padding: 20px;">
                <form id="edit-world-book-form">
                    <input type="hidden" id="world-book-id">
                    <div class="form-group">
                        <label for="world-book-name">条目名称</label>
                        <input type="text" id="world-book-name" placeholder="例如：世界观背景、魔法体系" required>
                    </div>
                    <div class="form-group">
                        <label for="world-book-priority">优先级 (1-10，数字越大优先级越高)</label>
                        <input type="number" id="world-book-priority" min="1" max="10" value="5">
                    </div>
                    <div class="form-group">
                        <label for="world-book-content">条目内容</label>
                        <textarea id="world-book-content" rows="8" placeholder="详细描述此项设定..." required></textarea>
                    </div>
                    <div class="form-group">
                        <label>注入位置</label>
                        <div class="form-group radio-group">
                            <label><input type="radio" name="world-book-position" value="before" checked> 前</label>
                            <label><input type="radio" name="world-book-position" value="after"> 后</label>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">保存条目</button>
                </form>
            </main>
        </div>

        <!-- API设置屏幕 -->
        <div id="api-settings-screen" class="screen">
            <header class="app-header">
                <button class="back-btn" data-target="home-screen">‹</button>
                <div class="title-container">
                    <h1 class="title">API 设置</h1>
                </div>
                <button class="action-btn" id="add-api-btn">+</button>
            </header>
            <main class="content" style="padding: 20px;">
                <!-- API列表 -->
                <div class="api-list" id="api-list">
                    <h3>已保存的API配置</h3>
                    <div id="api-items-container"></div>
                </div>
                
                <!-- API编辑表单 -->
                <form id="api-form">
                    <h3 id="api-form-title">添加新API</h3>
                    <input type="hidden" id="api-edit-id">
                    <div class="form-group">
                        <label for="api-name">配置名称</label>
                        <input type="text" id="api-name" placeholder="例如：主力API、备用API" required>
                    </div>
                    <div class="form-group">
                        <label for="api-provider">API 服务商</label>
                        <select id="api-provider" name="provider">
                            <option value="newapi">NewAPI (自定义)</option>
                            <option value="deepseek">DeepSeek</option>
                            <option value="claude">Claude</option>
                            <option value="gemini">Gemini</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="api-url">API 地址（后缀不用添加/v1）</label>
                        <input type="url" id="api-url" name="url" placeholder="选择服务商可自动填写" required>
                    </div>
                    <div class="form-group">
                        <label for="api-key">密钥 (Key)</label>
                        <input type="password" id="api-key" name="key" placeholder="请输入你的API密钥" required>
                    </div>
                    <button type="button" class="btn btn-secondary" id="fetch-models-btn">
                        <span class="btn-text">点击拉取模型</span>
                        <div class="spinner"></div>
                    </button>
                    <div class="form-group">
                        <label for="api-model">选择模型</label>
                        <select id="api-model" name="model" required>
                            <option value="">请先拉取模型列表</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary" id="save-api-btn">
                        <span class="btn-text">保 存</span>
                        <div class="spinner"></div>
                    </button>
                </form>
            </main>
        </div>

        <!-- 壁纸屏幕 -->
        <div id="wallpaper-screen" class="screen">
            <header class="app-header">
                <button class="back-btn" data-target="home-screen">‹</button>
                <div class="title-container">
                    <h1 class="title">更换壁纸</h1>
                </div>
                <div class="placeholder"></div>
            </header>
            <main class="content" style="padding: 20px;">
                <div class="wallpaper-preview" id="wallpaper-preview">
                    <span>当前壁纸预览</span>
                </div>
                <input type="file" id="wallpaper-upload" accept="image/*" style="display: none;">
                <label for="wallpaper-upload" class="btn btn-primary">从相册选择新壁纸</label>
            </main>
        </div>

        <!-- 字体设置屏幕 -->
        <div id="font-settings-screen" class="screen">
            <header class="app-header">
                <button class="back-btn" data-target="home-screen">‹</button>
                <div class="title-container">
                    <h1 class="title">字体设置</h1>
                </div>
                <div class="placeholder"></div>
            </header>
            <main class="content" style="padding: 20px;">
                <form id="font-settings-form">
                    <div class="form-group">
                        <label for="font-url">字体链接 (ttf, woff, woff2)</label>
                        <input type="url" id="font-url" placeholder="https://.../font.ttf" required>
                    </div>
                    <p style="font-size:12px; color:#888; text-align:center;">
                        示例: https://lf3-static.bytednsdoc.com/obj/eden-cn/jplptk/ljhwZthlaukjlkulzlp/portal/fonts/HarmonyOS_Sans_SC_Regular.woff2
                    </p>
                    <button type="submit" class="btn btn-primary">应用字体</button>
                    <button type="button" class="btn btn-neutral" id="restore-default-font-btn" style="margin-top: 15px;">恢复默认字体</button>
                </form>
            </main>
        </div>

        <!-- 自定义屏幕 -->
        <div id="customize-screen" class="screen">
            <header class="app-header">
                <button class="back-btn" data-target="home-screen">‹</button>
                <div class="title-container">
                    <h1 class="title">自定义设置</h1>
                </div>
                <div class="placeholder"></div>
            </header>
            <main class="content" style="padding: 20px;">
                <!-- 全局CSS编辑器 -->
                <div class="form-group">
                    <label for="global-css-editor">全局CSS自定义</label>
                    <div class="css-editor">
                        <textarea id="global-css-editor" placeholder="在此输入自定义CSS代码...&#10;例如：&#10;.app-header { background: linear-gradient(45deg, #ff6b6b, #4ecdc4); }&#10;.message-bubble { box-shadow: 0 4px 8px rgba(0,0,0,0.2); }"></textarea>
                    </div>
                    <button type="button" class="btn btn-primary" id="apply-global-css-btn" style="margin-top: 10px;">应用CSS</button>
                    <button type="button" class="btn btn-neutral" id="reset-global-css-btn" style="margin-top: 10px;">重置CSS</button>
                </div>
                
                <hr style="margin: 30px 0; border: none; border-top: 1px solid #eee;">
                
                <!-- 主屏幕图标自定义 -->
                <h3>主屏幕图标自定义</h3>
                <form id="customize-form"></form>
            </main>
        </div>

        <!-- 全屏设置面板 -->
        <div id="chat-settings-fullscreen" class="settings-fullscreen">
            <div class="settings-header">
                <button class="settings-close-btn" id="close-settings-btn">×</button>
                <div class="settings-title" id="settings-title">聊天设置</div>
                <div style="width: 40px;"></div>
            </div>
            <div class="settings-content" id="settings-content">
                <!-- 设置内容将在这里动态加载 -->
            </div>
        </div>

        <!-- Toast通知 -->
        <div id="toast-notification" class="toast"></div>

        <!-- 文件上传 -->
        <input type="file" id="image-upload-input" accept="image/*" style="display:none;">

        <!-- 模态框 -->
        <div id="add-char-modal" class="modal-overlay">
            <div class="modal-window">
                <h3>创建新角色</h3>
                <form id="add-char-form">
                    <div class="form-group">
                        <label for="char-real-name">角色姓名</label>
                        <input type="text" id="char-real-name" placeholder="角色的真实姓名" required>
                    </div>
                    <div class="form-group">
                        <label for="char-remark-name">角色备注 (昵称)</label>
                        <input type="text" id="char-remark-name" placeholder="你对Ta的称呼" required>
                    </div>
                    <div class="form-group">
                        <label for="my-name-for-char">我的姓名</label>
                        <input type="text" id="my-name-for-char" placeholder="你希望Ta如何称呼你" required>
                    </div>
                    <button type="submit" class="btn btn-primary">创建</button>
                </form>
            </div>
        </div>

        <div id="add-sticker-modal" class="modal-overlay">
            <div class="modal-window">
                <h3 id="add-sticker-modal-title">添加新表情</h3>
                <form id="add-sticker-form">
                    <input type="hidden" id="sticker-edit-id">
                    <div id="sticker-preview"><span>预览</span></div>
                    <div class="form-group">
                        <label for="sticker-name">表情名称</label>
                        <input type="text" id="sticker-name" placeholder="如：开心" required>
                    </div>
                    <div class="form-group">
                        <label for="sticker-url-input">表情URL</label>
                        <input type="url" id="sticker-url-input" placeholder="粘贴图片URL">
                    </div>
                    <p style="text-align:center; color:#888; margin: -10px 0 15px;">或</p>
                    <input type="file" id="sticker-file-upload" accept="image/*" style="display:none;">
                    <label for="sticker-file-upload" class="btn btn-secondary" style="width:100%; margin-bottom: 20px;">从本地上传</label>
                    <button type="submit" class="btn btn-primary">保存</button>
                </form>
            </div>
        </div>

        <div id="send-voice-modal" class="modal-overlay">
            <div class="modal-window">
                <h3>发送语音消息</h3>
                <form id="send-voice-form">
                    <div class="form-group">
                        <label for="voice-text-input">输入语音文字</label>
                        <textarea id="voice-text-input" placeholder="在这里输入你想说的话..." required rows="4"></textarea>
                    </div>
                    <div class="form-group" style="text-align:center; color:#888; font-size: 14px;">
                        预计时长: <span id="voice-duration-preview">0"</span>
                    </div>
                    <button type="submit" class="btn btn-primary">发送</button>
                </form>
            </div>
        </div>

        <div id="send-pv-modal" class="modal-overlay">
            <div class="modal-window">
                <h3>分享照片/视频</h3>
                <form id="send-pv-form">
                    <div class="form-group">
                        <label for="pv-text-input">输入描述</label>
                        <textarea id="pv-text-input" placeholder="在这里描述你的照片或视频内容..." required rows="4"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">发送</button>
                </form>
            </div>
        </div>

        <div id="send-transfer-modal" class="modal-overlay">
            <div class="modal-window">
                <h3>转账</h3>
                <form id="send-transfer-form">
                    <div class="form-group">
                        <label for="transfer-amount-input">金额 (元)</label>
                        <input type="number" id="transfer-amount-input" placeholder="0.00" required step="0.01" min="0.01">
                    </div>
                    <div class="form-group">
                        <label for="transfer-remark-input">备注</label>
                        <input type="text" id="transfer-remark-input" placeholder="（选填）">
                    </div>
                    <button type="submit" class="btn btn-primary">发送</button>
                </form>
            </div>
        </div>

        <div id="send-gift-modal" class="modal-overlay">
            <div class="modal-window">
                <h3>送出礼物</h3>
                <form id="send-gift-form">
                    <div class="form-group">
                        <label for="gift-description-input">礼物描述</label>
                        <textarea id="gift-description-input" placeholder="告诉Ta你送了什么特别的东西..." required rows="4"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">发送</button>
                </form>
            </div>
        </div>

        <div id="time-skip-modal" class="modal-overlay">
            <div class="modal-window">
                <h3>记录今天发生的事</h3>
                <form id="time-skip-form">
                    <div class="form-group">
                        <label for="time-skip-input">事件描述 (该消息AI可见，会作为上下文)</label>
                        <textarea id="time-skip-input" placeholder="例如：我们一起去山顶看了日落，然后吃了烧烤。" required rows="4"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">发送</button>
                </form>
            </div>
        </div>

        <div id="group-recipient-selection-modal" class="modal-overlay">
            <div class="modal-window">
                <h3 id="group-recipient-selection-title">选择收件人</h3>
                <ul id="group-recipient-selection-list"></ul>
                <button class="btn btn-primary" id="confirm-group-recipient-btn" style="margin-top: 20px;">确认</button>
            </div>
        </div>

        <div id="world-book-selection-modal" class="modal-overlay">
            <div class="modal-window">
                <h3>选择要关联的世界书</h3>
                <ul id="world-book-selection-list"></ul>
                <button class="btn btn-primary" id="save-world-book-selection-btn" style="margin-top: 20px;">确认</button>
            </div>
        </div>

        <div id="create-group-modal" class="modal-overlay">
            <div class="modal-window">
                <h3>创建群聊</h3>
                <form id="create-group-form">
                    <div class="form-group">
                        <label>选择群成员</label>
                        <ul id="member-selection-list" class="member-selection-list" style="list-style: none; margin: 0; padding: 0; max-height: 40vh; overflow-y: auto;"></ul>
                    </div>
                    <div class="form-group">
                        <label for="group-name-input">群聊名称</label>
                        <input type="text" id="group-name-input" placeholder="给你的群聊起个名字吧" required>
                    </div>
                    <button type="submit" class="btn btn-primary">创建群聊</button>
                </form>
            </div>
        </div>

        <!-- 动作表单 -->
        <div id="sticker-actionsheet" class="action-sheet-overlay">
            <div class="action-sheet">
                <button class="action-sheet-button" id="edit-sticker-btn">编辑</button>
                <button class="action-sheet-button danger" id="delete-sticker-btn">删除</button>
            </div>
        </div>

        <div id="receive-transfer-actionsheet" class="action-sheet-overlay">
            <div class="action-sheet">
                <button class="action-sheet-button" id="accept-transfer-btn">接收</button>
                <button class="action-sheet-button danger" id="return-transfer-btn">退回</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- 全局变量 ---
            let db = {
                characters: [],
                groups: [],
                apiConfigs: [], // 多API配置
                currentApiId: null, // 当前使用的API
                wallpaper: 'https://i.postimg.cc/W4Z9R9x4/ins-1.jpg',
                myStickers: [],
                homeScreenMode: 'night',
                worldBooks: [],
                fontUrl: '',
                customIcons: {},
                globalCustomCss: '' // 全局自定义CSS
            };

            let currentChatId = null;
            let currentChatType = null;
            let isGenerating = false;
            let longPressTimer = null;
            let isInMultiSelectMode = false;
            let editingMessageId = null;
            let currentPage = 1;
            let currentTransferMessageId = null;
            let currentEditingWorldBookId = null;
            let currentStickerActionTarget = null;
            let currentGroupAction = { type: null, recipients: [] };
            let selectedMessageIds = new Set();
            let currentEditingApiId = null;
            const MESSAGES_PER_PAGE = 50;

            // --- 颜色主题 ---
            const colorThemes = {
                'white_pink': { name: '白/粉', received: { bg: 'rgba(255,255,255,0.9)', text: '#6D6D6D' }, sent: { bg: 'rgba(255,204,204,0.9)', text: '#A56767' } },
                'white_blue': { name: '白/蓝', received: { bg: 'rgba(255,255,255,0.9)', text: '#6D6D6D' }, sent: { bg: 'rgba(173,216,230,0.9)', text: '#4A6F8A' } },
                'white_yellow': { name: '白/黄', received: { bg: 'rgba(255,255,255,0.9)', text: '#6D6D6D' }, sent: { bg: 'rgba(249,237,105,0.9)', text: '#8B7E4B' } },
                'white_green': { name: '白/绿', received: { bg: 'rgba(255,255,255,0.9)', text: '#6D6D6D' }, sent: { bg: 'rgba(188,238,188,0.9)', text: '#4F784F' } },
                'white_purple': { name: '白/紫', received: { bg: 'rgba(255,255,255,0.9)', text: '#6D6D6D' }, sent: { bg: 'rgba(185,190,240,0.9)', text: '#6C5B7B' } },
                'black_red': { name: '黑/红', received: { bg: 'rgba(30,30,30,0.85)', text: '#E0E0E0' }, sent: { bg: 'rgb(226,62,87,0.9)', text: '#fff' } },
                'black_green': { name: '黑/绿', received: { bg: 'rgba(30,30,30,0.85)', text: '#E0E0E0' }, sent: { bg: 'rgba(119,221,119,0.9)', text: '#2E5C2E' } },
                'black_white': { name: '黑/白', received: { bg: 'rgba(30,30,30,0.85)', text: '#E0E0E0' }, sent: { bg: 'rgba(245,245,245,0.9)', text: '#333' } },
                'white_black': { name: '白/黑', received: { bg: 'rgba(255,255,255,0.9)', text: '#6D6D6D' }, sent: { bg: 'rgba(50,50,50,0.85)', text: '#F5F5F5' } },
                'yellow_purple': { name: '黄/紫', received: { bg: 'rgba(255,250,205,0.9)', text: '#8B7E4B' }, sent: { bg: 'rgba(185,190,240,0.9)', text: '#6C5B7B' } },
                'pink_blue': { name: '粉/蓝', received: { bg: 'rgba(255,231,240,0.9)', text: '#7C6770' }, sent: { bg: 'rgba(173,216,230,0.9)', text: '#4A6F8A' } },
            };

            // --- 默认图标 ---
            const defaultIcons = {
                'chat-list-screen': { name: '404', url: 'https://i.postimg.cc/VvQB8dQT/chan-143.png' },
                'api-settings-screen': { name: 'API', url: 'https://i.postimg.cc/50FqT8GL/chan-125.png' },
                'wallpaper-screen': { name: '壁纸', url: 'https://i.postimg.cc/3wqFttL3/chan-90.png' },
                'world-book-screen': { name: '世界书', url: 'https://i.postimg.cc/prCWkrKT/chan-74.png' },
                'customize-screen': { name: '自定义', url: 'https://i.postimg.cc/vZVdC7gt/chan-133.png' },
                'font-settings-screen': { name: '字体', url: 'https://i.postimg.cc/FzVtC0x4/chan-21.png' },
                'day-mode-btn': { name: '', url: 'https://i.postimg.cc/Jz0tYqnT/chan-145.png' },
                'night-mode-btn': { name: '', url: 'https://i.postimg.cc/htYvkdQK/chan-146.png' }
            };

            // --- 工具函数 ---
            const saveData = () => localStorage.setItem('gemini-chat-app-db', JSON.stringify(db));
            const loadData = () => {
                const data = localStorage.getItem('gemini-chat-app-db');
                if (data) {
                    db = JSON.parse(data);
                    // 兼容旧版本数据
                    if (!db.apiConfigs) db.apiConfigs = [];
                    if (!db.currentApiId) db.currentApiId = null;
                    if (db.apiSettings && !db.currentApiId) {
                        // 迁移旧API设置
                        const oldApi = {
                            id: 'legacy_api',
                            name: '原有API',
                            provider: db.apiSettings.provider,
                            url: db.apiSettings.url,
                            key: db.apiSettings.key,
                            model: db.apiSettings.model
                        };
                        db.apiConfigs = [oldApi];
                        db.currentApiId = 'legacy_api';
                        delete db.apiSettings;
                    }
                    if (!db.globalCustomCss) db.globalCustomCss = '';
                    // 添加世界书优先级兼容
                    if (db.worldBooks) {
                        db.worldBooks.forEach(wb => {
                            if (wb.priority === undefined) wb.priority = 5;
                        });
                    }
                }
                // 初始化默认值
                if (!db.wallpaper) db.wallpaper = 'https://i.postimg.cc/W4Z9R9x4/ins-1.jpg';
                if (!db.characters) db.characters = [];
                if (!db.groups) db.groups = [];
                if (!db.myStickers) db.myStickers = [];
                if (!db.homeScreenMode) db.homeScreenMode = 'night';
                if (!db.worldBooks) db.worldBooks = [];
                if (!db.fontUrl) db.fontUrl = '';
                if (!db.customIcons) db.customIcons = {};
                
                // 兼容性处理
                db.characters.forEach(c => {
                    if (c.isPinned === undefined) c.isPinned = false;
                    if (c.status === undefined) c.status = '在线';
                    if (!c.worldBookIds) c.worldBookIds = [];
                    if (c.customBubbleCss === undefined) c.customBubbleCss = '';
                    if (c.useCustomBubbleCss === undefined) c.useCustomBubbleCss = false;
                });
                db.groups.forEach(g => {
                    if (g.isPinned === undefined) g.isPinned = false;
                    if (!g.worldBookIds) g.worldBookIds = [];
                    if (g.customBubbleCss === undefined) g.customBubbleCss = '';
                    if (g.useCustomBubbleCss === undefined) g.useCustomBubbleCss = false;
                });
            };

            const showToast = (message) => {
                const toastElement = document.getElementById('toast-notification');
                toastElement.textContent = message;
                toastElement.classList.add('show');
                setTimeout(() => toastElement.classList.remove('show'), 3000);
            };

            const switchScreen = (targetId) => {
                document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
                document.getElementById(targetId)?.classList.add('active');
                // 关闭所有弹窗和面板
                document.querySelectorAll('.modal-overlay, .action-sheet-overlay, .settings-fullscreen').forEach(o => {
                    o.classList.remove('visible', 'open');
                });
            };

            const pad = (num) => num.toString().padStart(2, '0');

            async function compressImage(file, options = {}) {
                const { quality = 0.8, maxWidth = 800, maxHeight = 800 } = options;
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onerror = reject;
                    reader.onload = (event) => {
                        const img = new Image();
                        img.src = event.target.result;
                        img.onerror = reject;
                        img.onload = () => {
                            let width = img.width;
                            let height = img.height;
                            if (width > height) {
                                if (width > maxWidth) {
                                    height = Math.round(height * (maxWidth / width));
                                    width = maxWidth;
                                }
                            } else {
                                if (height > maxHeight) {
                                    width = Math.round(width * (maxHeight / height));
                                    height = maxHeight;
                                }
                            }
                            const canvas = document.createElement('canvas');
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            resolve(canvas.toDataURL('image/jpeg', quality));
                        };
                    };
                });
            }

            // --- 日期工具函数 ---
            function formatDate(timestamp) {
                const date = new Date(timestamp);
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                
                if (date.toDateString() === today.toDateString()) {
                    return '今天';
                } else if (date.toDateString() === yesterday.toDateString()) {
                    return '昨天';
                } else {
                    return `${date.getMonth() + 1}月${date.getDate()}日`;
                }
            }

            function isSameDay(timestamp1, timestamp2) {
                const date1 = new Date(timestamp1);
                const date2 = new Date(timestamp2);
                return date1.toDateString() === date2.toDateString();
            }

            // --- 搜索功能 ---
            function setupChatSearch() {
                const searchInput = document.getElementById('chat-search-input');
                searchInput.addEventListener('input', (e) => {
                    const query = e.target.value.toLowerCase().trim();
                    filterChatList(query);
                });
            }

            function filterChatList(query) {
                const chatItems = document.querySelectorAll('.chat-item');
                let visibleCount = 0;
                
                chatItems.forEach(item => {
                    const itemName = item.querySelector('.item-name').textContent.toLowerCase();
                    const itemPreview = item.querySelector('.item-preview').textContent.toLowerCase();
                    
                    if (!query || itemName.includes(query) || itemPreview.includes(query)) {
                        item.style.display = 'flex';
                        visibleCount++;
                    } else {
                        item.style.display = 'none';
                    }
                });
                
                // 更新统计信息
                updateChatStats();
            }

            // --- 消息统计 ---
            function updateChatStats() {
                const stats = document.getElementById('chat-stats');
                const visibleChats = document.querySelectorAll('.chat-item[style*="flex"], .chat-item:not([style])').length;
                const totalChats = db.characters.length + db.groups.length;
                const totalMessages = [...db.characters, ...db.groups].reduce((sum, chat) => sum + (chat.history?.length || 0), 0);
                
                stats.textContent = `总计：${visibleChats}/${totalChats} 个聊天，${totalMessages} 条消息`;
            }

            // --- 单窗口数据统计 ---
            function updateChatRoomStats() {
                const stats = document.getElementById('chat-room-stats');
                if (!currentChatId || !stats) return;
                
                const chat = (currentChatType === 'private') ? 
                    db.characters.find(c => c.id === currentChatId) : 
                    db.groups.find(g => g.id === currentChatId);
                
                if (!chat || !chat.history) {
                    stats.style.display = 'none';
                    return;
                }
                
                const messages = chat.history;
                const messageCount = messages.length;
                const userMessages = messages.filter(m => m.role === 'user').length;
                const aiReplies = messages.filter(m => m.role === 'assistant').length;
                
                // 计算字符数（只计算文本消息）
                const totalChars = messages.reduce((sum, msg) => {
                    const textMatch = msg.content.match(/\[.*?的消息：([\s\S]+?)\]/);
                    const text = textMatch ? textMatch[1] : msg.content;
                    return sum + (text?.length || 0);
                }, 0);
                
                stats.textContent = `当前聊天：${messageCount} 条消息，${totalChars} 字符，${aiReplies} 次AI回复`;
                stats.style.display = 'block';
            }

            // --- 时钟更新 ---
            function updateClock() {
                const now = new Date();
                const timeDisplay = document.getElementById('time-display');
                const dateDisplay = document.getElementById('date-display');
                if (timeDisplay) timeDisplay.textContent = `${pad(now.getHours())}:${pad(now.getMinutes())}`;
                if (dateDisplay) dateDisplay.textContent = `${now.getFullYear()}年${pad(now.getMonth() + 1)}月${pad(now.getDate())}日`;
            }

            // --- 应用全局CSS ---
            function applyGlobalCustomCss() {
                const styleId = 'global-custom-css';
                let styleElement = document.getElementById(styleId);
                
                if (!styleElement) {
                    styleElement = document.createElement('style');
                    styleElement.id = styleId;
                    document.head.appendChild(styleElement);
                }
                
                styleElement.textContent = db.globalCustomCss || '';
            }

            // --- 全局字体 ---
            function applyGlobalFont(fontUrl) {
                const styleId = 'global-font-style';
                let styleElement = document.getElementById(styleId);
                if (!styleElement) {
                    styleElement = document.createElement('style');
                    styleElement.id = styleId;
                    document.head.appendChild(styleElement);
                }
                if (fontUrl) {
                    const fontName = 'CustomGlobalFont';
                    styleElement.innerHTML = `@font-face { font-family: '${fontName}'; src: url('${fontUrl}'); } :root { --font-family: '${fontName}', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }`;
                } else {
                    styleElement.innerHTML = `:root { --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }`;
                }
            }

            // --- API管理 ---
            function getCurrentApiConfig() {
                return db.apiConfigs.find(api => api.id === db.currentApiId);
            }

            function setCurrentApi(apiId) {
                db.currentApiId = apiId;
                saveData();
                renderApiList();
            }

            function renderApiList() {
                const container = document.getElementById('api-items-container');
                container.innerHTML = '';
                
                if (db.apiConfigs.length === 0) {
                    container.innerHTML = '<p style="color: #888; text-align: center;">暂无API配置</p>';
                    return;
                }
                
                db.apiConfigs.forEach(api => {
                    const item = document.createElement('div');
                    item.className = `api-item ${api.id === db.currentApiId ? 'active' : ''}`;
                    item.innerHTML = `
                        <div class="api-item-info">
                            <div class="api-item-name">${api.name}</div>
                            <div class="api-item-model">${api.provider} - ${api.model || '未设置'}</div>
                        </div>
                        <div class="api-item-actions">
                            <button class="api-item-btn edit" data-id="${api.id}">编辑</button>
                            <button class="api-item-btn delete" data-id="${api.id}">删除</button>
                        </div>
                    `;
                    
                    // 点击选择API
                    item.addEventListener('click', (e) => {
                        if (!e.target.matches('.api-item-btn')) {
                            setCurrentApi(api.id);
                        }
                    });
                    
                    container.appendChild(item);
                });
            }

            // --- 主屏幕设置 ---
            function setupHomeScreen() {
                updateClock();
                setInterval(updateClock, 30000);
                applyWallpaper(db.wallpaper);
                applyHomeScreenMode(db.homeScreenMode);
                
                document.getElementById('day-mode-btn')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    applyHomeScreenMode('day');
                });
                document.getElementById('night-mode-btn')?.addEventListener('click', (e) => {
                    e.preventDefault();
                    applyHomeScreenMode('night');
                });
            }

            function applyWallpaper(url) {
                document.getElementById('home-screen').style.backgroundImage = `url(${url})`;
            }

            function applyHomeScreenMode(mode) {
                const homeScreen = document.getElementById('home-screen');
                if (mode === 'day') {
                    homeScreen.classList.add('day-mode');
                } else {
                    homeScreen.classList.remove('day-mode');
                }
                db.homeScreenMode = mode;
                saveData();
            }

            // --- 聊天列表 ---
            function renderChatList() {
                const container = document.getElementById('chat-list-container');
                const placeholder = document.getElementById('no-chats-placeholder');
                
                container.innerHTML = '';
                const allChats = [
                    ...db.characters.map(c => ({ ...c, type: 'private' })),
                    ...db.groups.map(g => ({ ...g, type: 'group' }))
                ];
                
                placeholder.style.display = allChats.length === 0 ? 'block' : 'none';
                
                // 排序：置顶优先，然后按最后消息时间
                const sortedChats = allChats.sort((a, b) => {
                    if (a.isPinned !== b.isPinned) return a.isPinned ? -1 : 1;
                    const lastMsgTimeA = a.history && a.history.length > 0 ? a.history[a.history.length - 1].timestamp : 0;
                    const lastMsgTimeB = b.history && b.history.length > 0 ? b.history[b.history.length - 1].timestamp : 0;
                    return lastMsgTimeB - lastMsgTimeA;
                });
                
                sortedChats.forEach(chat => {
                    let lastMessageText = '开始聊天吧...';
                    if (chat.history && chat.history.length > 0) {
                        const invisibleRegex = /\[.*?(?:接收|退回).*?的转账\]|\[.*?更新状态为：.*?\]|\[.*?已接收礼物\]|\[system:.*?\]|\[.*?邀请.*?加入了群聊\]|\[.*?修改群名为：.*?\]|\[system-display:.*?\]/;
                        const visibleHistory = chat.history.filter(msg => !invisibleRegex.test(msg.content));
                        if (visibleHistory.length > 0) {
                            const lastMsg = visibleHistory[visibleHistory.length - 1];
                            const urlRegex = /^(https?:\/\/[^\s]+\.(?:jpg|jpeg|png|gif|webp|bmp|svg)|data:image\/[a-z]+;base64,)/i;
                            const imageRecogRegex = /\[.*?发来了一张图片：\]/;
                            const voiceRegex = /\[.*?的语音：.*?\]/;
                            const photoVideoRegex = /\[.*?发来的照片\/视频：.*?\]/;
                            const transferRegex = /\[.*?的转账：.*?元.*?\]|\[.*?给你转账：.*?元.*?\]|\[.*?向.*?转账：.*?元.*?\]/;
                            const stickerRegex = /\[.*?的表情包：.*?\]|\[.*?发送的表情包：.*?\]/;
                            const giftRegex = /\[.*?送来的礼物：.*?\]|\[.*?向.*?送来了礼物：.*?\]/;

                            if (giftRegex.test(lastMsg.content)) {
                                lastMessageText = '[礼物]';
                            } else if (stickerRegex.test(lastMsg.content)) {
                                lastMessageText = '[表情包]';
                            } else if (voiceRegex.test(lastMsg.content)) {
                                lastMessageText = '[语音]';
                            } else if (photoVideoRegex.test(lastMsg.content)) {
                                lastMessageText = '[照片/视频]';
                            } else if (transferRegex.test(lastMsg.content)) {
                                lastMessageText = '[转账]';
                            } else if (imageRecogRegex.test(lastMsg.content) || (lastMsg.parts && lastMsg.parts.some(p => p.type === 'image'))) {
                                lastMessageText = '[图片]';
                            } else {
                                const textMatch = lastMsg.content.match(/\[.*?的消息：([\s\S]+)\]/);
                                let text = textMatch ? textMatch[1].trim() : lastMsg.content.trim();
                                lastMessageText = urlRegex.test(text) ? '[图片]' : text;
                            }
                        }
                    }
                    
                    const li = document.createElement('li');
                    li.className = 'list-item chat-item';
                    if (chat.isPinned) li.classList.add('pinned');
                    li.dataset.id = chat.id;
                    li.dataset.type = chat.type;
                    
                    const avatarClass = chat.type === 'group' ? 'group-avatar' : '';
                    const itemName = chat.type === 'private' ? chat.remarkName : chat.name;
                    const pinBadgeHTML = chat.isPinned ? '<span class="pin-badge">置顶</span>' : '';
                    
                    li.innerHTML = `
                        <img src="${chat.avatar}" alt="${itemName}" class="chat-avatar ${avatarClass}">
                        <div class="item-details">
                            <div class="item-details-row">
                                <div class="item-name">${itemName}</div>
                            </div>
                            <div class="item-preview-wrapper">
                                <div class="item-preview">${lastMessageText}</div>
                                ${pinBadgeHTML}
                            </div>
                        </div>`;
                    container.appendChild(li);
                });
                
                updateChatStats();
            }

            // --- 消息渲染 ---
            function createMessageBubbleElement(message) {
                const chat = (currentChatType === 'private') ? 
                    db.characters.find(c => c.id === currentChatId) : 
                    db.groups.find(g => g.id === currentChatId);
                
                const { role, content, timestamp, id, transferStatus, giftStatus, stickerData, senderId } = message;

                // 处理系统消息
                const timeSkipRegex = /\[system-display:([\s\S]+?)\]/;
                const inviteRegex = /\[(.*?)邀请(.*?)加入了群聊\]/;
                const renameRegex = /\[(.*?)修改群名为：(.*?)\]/;
                const timeSkipMatch = content.match(timeSkipRegex);
                const inviteMatch = content.match(inviteRegex);
                const renameMatch = content.match(renameRegex);
                const invisibleRegex = /\[.*?(?:接收|退回).*?的转账\]|\[.*?更新状态为：.*?\]|\[.*?已接收礼物\]|\[system:.*?\]/;
                
                if (invisibleRegex.test(content)) {
                    return null;
                }

                const wrapper = document.createElement('div');
                wrapper.dataset.id = id;

                // 系统通知消息
                if (timeSkipMatch || inviteMatch || renameMatch) {
                    wrapper.className = 'message-wrapper system-notification';
                    let bubbleText = '';
                    if (timeSkipMatch) bubbleText = timeSkipMatch[1];
                    if (inviteMatch) bubbleText = `${inviteMatch[1]}邀请${inviteMatch[2]}加入了群聊`;
                    if (renameMatch) bubbleText = `${renameMatch[1]}修改群名为"${renameMatch[2]}"`;
                    wrapper.innerHTML = `<div class="system-notification-bubble">${bubbleText}</div>`;
                    return wrapper;
                }

                const isSent = (role === 'user');
                const themeKey = chat.theme || 'white_pink';
                const theme = colorThemes[themeKey] || colorThemes['white_pink'];
                
                wrapper.className = `message-wrapper ${isSent ? 'sent' : 'received'}`;
                if (currentChatType === 'group' && !isSent) {
                    wrapper.classList.add('group-message');
                }

                const timeString = `${pad(new Date(timestamp).getHours())}:${pad(new Date(timestamp).getMinutes())}`;
                
                let bubbleElement;
                
                // 各种消息类型的正则
                const textRegex = /\[(?:.+?)的消息：([\s\S]+?)\]/;
                const voiceRegex = /\[(?:.+?)的语音：([\s\S]+?)\]/;
                const stickerRegex = /\[(?:.+?)发送的表情包：([\s\S]+?)\]/;
                const photoVideoRegex = /\[(?:.+?)发来的照片\/视频：([\s\S]+?)\]/;
                const transferRegex = /\[.*?的转账：([\d.]+)元；备注：(.*?)\]/;
                const giftRegex = /\[(?:.+?)送来的礼物：([\s\S]+?)\]/;
                const urlRegex = /^(https?:\/\/[^\s]+\.(?:jpg|jpeg|png|gif|webp|bmp|svg)|data:image\/[a-z]+;base64,)/i;

                const textMatch = content.match(textRegex);
                const voiceMatch = content.match(voiceRegex);
                const stickerMatch = content.match(stickerRegex);
                const photoVideoMatch = content.match(photoVideoRegex);
                const transferMatch = content.match(transferRegex);
                const giftMatch = content.match(giftRegex);

                if (textMatch) {
                    bubbleElement = document.createElement('div');
                    bubbleElement.className = `message-bubble ${isSent ? 'sent' : 'received'}`;
                    bubbleElement.textContent = textMatch[1].trim();
                    bubbleElement.setAttribute('data-time', timeString);
                } else if (voiceMatch) {
                    bubbleElement = document.createElement('div');
                    bubbleElement.className = 'voice-bubble';
                    if (!chat.useCustomBubbleCss) {
                        const bubbleTheme = isSent ? theme.sent : theme.received;
                        bubbleElement.style.backgroundColor = bubbleTheme.bg;
                        bubbleElement.style.color = bubbleTheme.text;
                    }
                    const duration = Math.max(1, Math.min(60, Math.ceil(voiceMatch[1].trim().length / 3.5)));
                    bubbleElement.innerHTML = `
                        <svg class="play-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M8 5v14l11-7z"></path>
                        </svg>
                        <span class="duration">${duration}"</span>`;
                    
                    const transcriptDiv = document.createElement('div');
                    transcriptDiv.className = 'voice-transcript';
                    transcriptDiv.textContent = voiceMatch[1].trim();
                    wrapper.appendChild(transcriptDiv);
                } else if (stickerMatch && stickerData) {
                    bubbleElement = document.createElement('div');
                    bubbleElement.className = 'image-bubble';
                    bubbleElement.innerHTML = `<img src="${stickerData}" alt="表情包">`;
                } else if (photoVideoMatch) {
                    bubbleElement = document.createElement('div');
                    bubbleElement.className = 'pv-card';
                    const bgImage = isSent ? 'https://i.postimg.cc/L8NFrBrW/1752307494497.jpg' : 'https://i.postimg.cc/1tH6ds9g/1752301200490.jpg';
                    bubbleElement.innerHTML = `
                        <div class="pv-card-content">${photoVideoMatch[1].trim()}</div>
                        <div class="pv-card-image-overlay" style="background-image: url('${bgImage}');"></div>
                        <div class="pv-card-footer">
                            <svg viewBox="0 0 24 24">
                                <path d="M4,4H20A2,2 0 0,1 22,6V18A2,2 0 0,1 20,20H4A2,2 0 0,1 2,18V6A2,2 0 0,1 4,4M4,6V18H20V6H4M10,9A1,1 0 0,1 11,10A1,1 0 0,1 10,11A1,1 0 0,1 9,10A1,1 0 0,1 10,9M8,17L11,13L13,15L17,10L20,14V17H8Z"></path>
                            </svg>
                            <span>照片/视频・点击查看</span>
                        </div>`;
                } else if (transferMatch) {
                    bubbleElement = document.createElement('div');
                    bubbleElement.className = `transfer-card ${isSent ? 'sent-transfer' : 'received-transfer'}`;
                    const amount = parseFloat(transferMatch[1]).toFixed(2);
                    const remark = transferMatch[2] || '';
                    let statusText = isSent ? '待查收' : '转账给你';
                    
                    if (transferStatus === 'received') {
                        statusText = '已收款';
                        bubbleElement.classList.add('received');
                    } else if (transferStatus === 'returned') {
                        statusText = '已退回';
                        bubbleElement.classList.add('returned');
                    }
                    
                    const remarkHTML = remark ? `<p class="transfer-remark">${remark}</p>` : '';
                    bubbleElement.innerHTML = `
                        <div class="overlay"></div>
                        <div class="transfer-content">
                            <p class="transfer-title">${isSent ? '给你转账' : '转账'}</p>
                            <p class="transfer-amount">¥${amount}</p>
                            ${remarkHTML}
                            <p class="transfer-status">${statusText}</p>
                        </div>`;
                } else if (giftMatch) {
                    bubbleElement = document.createElement('div');
                    bubbleElement.className = 'gift-card';
                    if (giftStatus === 'received') {
                        bubbleElement.classList.add('received');
                    }
                    
                    bubbleElement.innerHTML = `
                        <img src="https://i.postimg.cc/rp0Yg31K/chan-75.png" alt="gift" class="gift-card-icon">
                        <div class="gift-card-text">您有一份礼物～</div>
                        <div class="gift-card-received-stamp">已查收</div>`;
                    
                    const descriptionDiv = document.createElement('div');
                    descriptionDiv.className = 'gift-card-description';
                    descriptionDiv.textContent = giftMatch[1].trim();
                    wrapper.appendChild(descriptionDiv);
                } else if (urlRegex.test(content)) {
                    bubbleElement = document.createElement('div');
                    bubbleElement.className = 'image-bubble';
                    bubbleElement.innerHTML = `<img src="${content}" alt="图片消息">`;
                } else {
                    bubbleElement = document.createElement('div');
                    bubbleElement.className = `message-bubble ${isSent ? 'sent' : 'received'}`;
                    bubbleElement.textContent = content;
                    bubbleElement.setAttribute('data-time', timeString);
                }

                if (bubbleElement) {
                    wrapper.appendChild(bubbleElement);
                }

                return wrapper;
            }

            function renderMessages(isLoadMore = false, forceScrollToBottom = false) {
                const chat = (currentChatType === 'private') ? 
                    db.characters.find(c => c.id === currentChatId) : 
                    db.groups.find(g => g.id === currentChatId);
                
                if (!chat || !chat.history) return;

                const messageArea = document.getElementById('message-area');
                const oldScrollHeight = messageArea.scrollHeight;
                const totalMessages = chat.history.length;
                const end = totalMessages - (currentPage - 1) * MESSAGES_PER_PAGE;
                const start = Math.max(0, end - MESSAGES_PER_PAGE);
                const messagesToRender = chat.history.slice(start, end);

                if (!isLoadMore) messageArea.innerHTML = '';

                const fragment = document.createDocumentFragment();
                let lastDate = null;

                messagesToRender.forEach((msg, index) => {
                    // 添加日期分隔符
                    const msgDate = formatDate(msg.timestamp);
                    if (msgDate !== lastDate) {
                        const dateSeparator = document.createElement('div');
                        dateSeparator.className = 'date-separator';
                        dateSeparator.innerHTML = `
                            <div class="date-separator-line"></div>
                            <div class="date-separator-text">${msgDate}</div>`;
                        fragment.appendChild(dateSeparator);
                        lastDate = msgDate;
                    }

                    const bubble = createMessageBubbleElement(msg);
                    if (bubble) fragment.appendChild(bubble);
                });

                const existingLoadBtn = document.getElementById('load-more-btn');
                if (existingLoadBtn) existingLoadBtn.remove();
                
                messageArea.prepend(fragment);

                if (totalMessages > currentPage * MESSAGES_PER_PAGE) {
                    const loadMoreButton = document.createElement('button');
                    loadMoreButton.id = 'load-more-btn';
                    loadMoreButton.className = 'load-more-btn';
                    loadMoreButton.textContent = '加载更早的消息';
                    messageArea.prepend(loadMoreButton);
                }

                if (forceScrollToBottom) {
                    setTimeout(() => {
                        messageArea.scrollTop = messageArea.scrollHeight;
                    }, 0);
                } else if (isLoadMore) {
                    messageArea.scrollTop = messageArea.scrollHeight - oldScrollHeight;
                }
                
                updateChatRoomStats(); // 更新单窗口统计
            }

            // --- 初始化函数 ---
            function init() {
                loadData();
                applyGlobalFont(db.fontUrl);
                applyGlobalCustomCss();
                
                // 事件委托
                document.body.addEventListener('click', (e) => {
                    // 返回按钮
                    const backBtn = e.target.closest('.back-btn');
                    if (backBtn) {
                        e.preventDefault();
                        switchScreen(backBtn.getAttribute('data-target'));
                        return;
                    }

                    // 屏幕切换
                    const navLink = e.target.closest('.app-icon[data-target]');
                    if (navLink) {
                        e.preventDefault();
                        switchScreen(navLink.getAttribute('data-target'));
                        return;
                    }

                    // 关闭弹窗
                    const openOverlay = document.querySelector('.modal-overlay.visible, .action-sheet-overlay.visible');
                    if (openOverlay && e.target === openOverlay) {
                        openOverlay.classList.remove('visible');
                        return;
                    }

                    // 聊天项点击
                    const chatItem = e.target.closest('.chat-item');
                    if (chatItem) {
                        currentChatId = chatItem.dataset.id;
                        currentChatType = chatItem.dataset.type;
                        openChatRoom(currentChatId, currentChatType);
                        return;
                    }

                    // API项操作
                    if (e.target.matches('.api-item-btn.edit')) {
                        editApiConfig(e.target.dataset.id);
                        return;
                    }
                    if (e.target.matches('.api-item-btn.delete')) {
                        deleteApiConfig(e.target.dataset.id);
                        return;
                    }
                });

                setupHomeScreen();
                setupChatSearch();
                setupApiSettings();
                setupWallpaperApp();
                setupFontSettings();
                setupCustomizeApp();
                setupWorldBookApp();
                setupChatRoom();
                setupChatSettings();
                setupWorldBookSelection();
                
                // 初始化页面
                renderChatList();
                renderApiList();
                renderWorldBookList();
                renderCustomizeForm();
                updateClock();
            }

            // --- API设置 ---
            function setupApiSettings() {
                const providerUrls = {
                    newapi: '',
                    deepseek: 'https://api.deepseek.com',
                    claude: 'https://api.anthropic.com',
                    gemini: 'https://generativelanguage.googleapis.com'
                };

                const addApiBtn = document.getElementById('add-api-btn');
                const apiForm = document.getElementById('api-form');
                const providerSelect = document.getElementById('api-provider');
                const urlInput = document.getElementById('api-url');
                const fetchModelsBtn = document.getElementById('fetch-models-btn');
                const modelSelect = document.getElementById('api-model');

                addApiBtn.addEventListener('click', () => {
                    resetApiForm();
                    document.getElementById('api-form-title').textContent = '添加新API';
                });

                providerSelect.addEventListener('change', () => {
                    urlInput.value = providerUrls[providerSelect.value] || '';
                });

                fetchModelsBtn.addEventListener('click', fetchModels);
                apiForm.addEventListener('submit', saveApiConfig);
            }

            function resetApiForm() {
                document.getElementById('api-form').reset();
                document.getElementById('api-edit-id').value = '';
                document.getElementById('api-model').innerHTML = '<option value="">请先拉取模型列表</option>';
                currentEditingApiId = null;
            }

            function editApiConfig(apiId) {
                const api = db.apiConfigs.find(a => a.id === apiId);
                if (!api) return;

                currentEditingApiId = apiId;
                document.getElementById('api-form-title').textContent = '编辑API配置';
                document.getElementById('api-edit-id').value = api.id;
                document.getElementById('api-name').value = api.name;
                document.getElementById('api-provider').value = api.provider;
                document.getElementById('api-url').value = api.url;
                document.getElementById('api-key').value = api.key;
                
                if (api.model) {
                    document.getElementById('api-model').innerHTML = `<option value="${api.model}">${api.model}</option>`;
                }
            }

            function deleteApiConfig(apiId) {
                const api = db.apiConfigs.find(a => a.id === apiId);
                if (!api) return;

                if (confirm(`确定要删除API配置"${api.name}"吗？`)) {
                    db.apiConfigs = db.apiConfigs.filter(a => a.id !== apiId);
                    if (db.currentApiId === apiId) {
                        db.currentApiId = db.apiConfigs.length > 0 ? db.apiConfigs[0].id : null;
                    }
                    saveData();
                    renderApiList();
                    showToast('API配置已删除');
                }
            }

            async function fetchModels() {
                const provider = document.getElementById('api-provider').value;
                const url = document.getElementById('api-url').value.trim();
                const key = document.getElementById('api-key').value.trim();

                if (!url || !key) {
                    showToast('请先填写API地址和密钥！');
                    return;
                }

                const fetchBtn = document.getElementById('fetch-models-btn');
                const modelSelect = document.getElementById('api-model');
                
                fetchBtn.classList.add('loading');
                fetchBtn.disabled = true;

                try {
                    const cleanUrl = url.endsWith('/') ? url.slice(0, -1) : url;
                    const endpoint = provider === 'gemini' ? 
                        `${cleanUrl}/v1beta/models?key=${key}` : 
                        `${cleanUrl}/v1/models`;
                    
                    const headers = provider === 'gemini' ? 
                        {} : 
                        { Authorization: `Bearer ${key}` };

                    const response = await fetch(endpoint, { method: 'GET', headers });
                    if (!response.ok) throw new Error(`网络响应错误: ${response.status}`);

                    const data = await response.json();
                    let models = [];

                    if (provider === 'gemini' && data.models) {
                        models = data.models.map(m => m.name.replace('models/', ''));
                    } else if (data.data) {
                        models = data.data.map(m => m.id);
                    }

                    modelSelect.innerHTML = '';
                    if (models.length > 0) {
                        models.forEach(model => {
                            const option = document.createElement('option');
                            option.value = model;
                            option.textContent = model;
                            modelSelect.appendChild(option);
                        });
                        showToast('模型列表拉取成功！');
                    } else {
                        modelSelect.innerHTML = '<option value="">未找到任何模型</option>';
                    }
                } catch (error) {
                    showToast(`拉取失败: ${error.message}`);
                    modelSelect.innerHTML = '<option value="">拉取失败</option>';
                } finally {
                    fetchBtn.classList.remove('loading');
                    fetchBtn.disabled = false;
                }
            }

            function saveApiConfig(e) {
                e.preventDefault();
                
                const formData = new FormData(e.target);
                const name = document.getElementById('api-name').value.trim();
                const model = document.getElementById('api-model').value;
                
                if (!name || !model) {
                    showToast('请填写完整的配置信息！');
                    return;
                }

                const apiConfig = {
                    id: currentEditingApiId || `api_${Date.now()}`,
                    name: name,
                    provider: formData.get('provider'),
                    url: formData.get('url'),
                    key: formData.get('key'),
                    model: model
                };

                if (currentEditingApiId) {
                    const index = db.apiConfigs.findIndex(a => a.id === currentEditingApiId);
                    if (index > -1) {
                        db.apiConfigs[index] = apiConfig;
                    }
                } else {
                    db.apiConfigs.push(apiConfig);
                    if (!db.currentApiId) {
                        db.currentApiId = apiConfig.id;
                    }
                }

                saveData();
                renderApiList();
                resetApiForm();
                showToast('API配置已保存！');
            }

            // --- 壁纸应用 ---
            function setupWallpaperApp() {
                const uploadInput = document.getElementById('wallpaper-upload');
                const preview = document.getElementById('wallpaper-preview');
                
                preview.style.backgroundImage = `url(${db.wallpaper})`;
                preview.textContent = '';
                
                uploadInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        try {
                            const compressedUrl = await compressImage(file, { 
                                quality: 0.85, 
                                maxWidth: 1080, 
                                maxHeight: 1920 
                            });
                            db.wallpaper = compressedUrl;
                            applyWallpaper(compressedUrl);
                            preview.style.backgroundImage = `url(${compressedUrl})`;
                            saveData();
                            showToast('壁纸更换成功！');
                        } catch (error) {
                            showToast('壁纸压缩失败，请重试');
                        }
                    }
                });
            }

            // --- 字体设置 ---
            function setupFontSettings() {
                const fontForm = document.getElementById('font-settings-form');
                const fontUrlInput = document.getElementById('font-url');
                const restoreBtn = document.getElementById('restore-default-font-btn');
                
                fontUrlInput.value = db.fontUrl;
                
                fontForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const newFontUrl = fontUrlInput.value.trim();
                    db.fontUrl = newFontUrl;
                    saveData();
                    applyGlobalFont(newFontUrl);
                    showToast('新字体已应用！');
                });
                
                restoreBtn.addEventListener('click', () => {
                    fontUrlInput.value = '';
                    db.fontUrl = '';
                    saveData();
                    applyGlobalFont('');
                    showToast('已恢复默认字体！');
                });
            }

            // --- 自定义应用 ---
            function setupCustomizeApp() {
                const globalCssEditor = document.getElementById('global-css-editor');
                const applyCssBtn = document.getElementById('apply-global-css-btn');
                const resetCssBtn = document.getElementById('reset-global-css-btn');
                const customizeForm = document.getElementById('customize-form');
                
                // 加载当前CSS
                globalCssEditor.value = db.globalCustomCss || '';
                
                applyCssBtn.addEventListener('click', () => {
                    db.globalCustomCss = globalCssEditor.value;
                    saveData();
                    applyGlobalCustomCss();
                    showToast('自定义CSS已应用！');
                });
                
                resetCssBtn.addEventListener('click', () => {
                    if (confirm('确定要重置所有自定义CSS吗？')) {
                        globalCssEditor.value = '';
                        db.globalCustomCss = '';
                        saveData();
                        applyGlobalCustomCss();
                        showToast('CSS已重置！');
                    }
                });

                // 图标自定义
                customizeForm.addEventListener('input', (e) => {
                    if (e.target.matches('input[type="url"]')) {
                        const iconId = e.target.dataset.id;
                        const newUrl = e.target.value.trim();
                        if (newUrl) {
                            db.customIcons[iconId] = newUrl;
                            const previewImg = document.getElementById(`icon-preview-${iconId}`);
                            if (previewImg) previewImg.src = newUrl;
                            saveData();
                        }
                    }
                });
                
                customizeForm.addEventListener('click', (e) => {
                    if (e.target.matches('.reset-icon-btn')) {
                        const iconId = e.target.dataset.id;
                        delete db.customIcons[iconId];
                        saveData();
                        renderCustomizeForm();
                        showToast('图标已重置');
                    }
                });
            }

            function renderCustomizeForm() {
                const form = document.getElementById('customize-form');
                form.innerHTML = '';
                
                Object.entries(defaultIcons).forEach(([id, { name, url }]) => {
                    const currentIcon = db.customIcons[id] || url;
                    const itemHTML = `
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0;">
                            <img src="${currentIcon}" alt="${name}" style="width: 50px; height: 50px; border-radius: 12px; object-fit: cover; flex-shrink: 0;" id="icon-preview-${id}">
                            <div style="flex-grow: 1;">
                                <p style="margin: 0 0 8px 0; font-weight: 600;">${name || '模式切换'}</p>
                                <input type="url" placeholder="粘贴新的图标URL" value="${db.customIcons[id] || ''}" data-id="${id}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                            </div>
                            <button type="button" class="reset-icon-btn" data-id="${id}" style="background: #e0e0e0; color: #555; border: none; border-radius: 8px; padding: 8px 10px; font-size: 12px; cursor: pointer;">重置</button>
                        </div>`;
                    form.insertAdjacentHTML('beforeend', itemHTML);
                });
            }

            // --- 世界书应用 ---
            function setupWorldBookApp() {
                const addBtn = document.getElementById('add-world-book-btn');
                const editForm = document.getElementById('edit-world-book-form');
                const listContainer = document.getElementById('world-book-list-container');
                
                addBtn.addEventListener('click', () => {
                    currentEditingWorldBookId = null;
                    editForm.reset();
                    document.querySelector('input[name="world-book-position"][value="before"]').checked = true;
                    document.getElementById('world-book-priority').value = 5;
                    switchScreen('edit-world-book-screen');
                });
                
                editForm.addEventListener('submit', saveWorldBook);
                
                listContainer.addEventListener('click', (e) => {
                    const item = e.target.closest('.world-book-item');
                    if (item) {
                        editWorldBook(item.dataset.id);
                    }
                });
                
                listContainer.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    const item = e.target.closest('.world-book-item');
                    if (item) {
                        showWorldBookContextMenu(item.dataset.id, e.clientX, e.clientY);
                    }
                });
            }

            function saveWorldBook(e) {
                e.preventDefault();
                
                const name = document.getElementById('world-book-name').value.trim();
                const content = document.getElementById('world-book-content').value.trim();
                const priority = parseInt(document.getElementById('world-book-priority').value);
                const position = document.querySelector('input[name="world-book-position"]:checked').value;
                
                if (!name || !content) {
                    showToast('名称和内容不能为空');
                    return;
                }
                
                const worldBook = {
                    id: currentEditingWorldBookId || `wb_${Date.now()}`,
                    name,
                    content,
                    priority,
                    position
                };
                
                if (currentEditingWorldBookId) {
                    const index = db.worldBooks.findIndex(wb => wb.id === currentEditingWorldBookId);
                    if (index > -1) {
                        db.worldBooks[index] = worldBook;
                    }
                } else {
                    db.worldBooks.push(worldBook);
                }
                
                saveData();
                showToast('世界书条目已保存');
                renderWorldBookList();
                switchScreen('world-book-screen');
            }

            function editWorldBook(id) {
                const book = db.worldBooks.find(wb => wb.id === id);
                if (!book) return;
                
                currentEditingWorldBookId = id;
                document.getElementById('world-book-id').value = id;
                document.getElementById('world-book-name').value = book.name;
                document.getElementById('world-book-content').value = book.content;
                document.getElementById('world-book-priority').value = book.priority || 5;
                document.querySelector(`input[name="world-book-position"][value="${book.position}"]`).checked = true;
                switchScreen('edit-world-book-screen');
            }

            function showWorldBookContextMenu(id, x, y) {
                const menuItems = [{
                    label: '删除',
                    danger: true,
                    action: () => {
                        if (confirm('确定要删除这个世界书条目吗？')) {
                            db.worldBooks = db.worldBooks.filter(wb => wb.id !== id);
                            // 清理引用
                            db.characters.forEach(char => {
                                char.worldBookIds = (char.worldBookIds || []).filter(wbId => wbId !== id);
                            });
                            db.groups.forEach(group => {
                                group.worldBookIds = (group.worldBookIds || []).filter(wbId => wbId !== id);
                            });
                            saveData();
                            renderWorldBookList();
                            showToast('条目已删除');
                        }
                    }
                }];
                createContextMenu(menuItems, x, y);
            }

            function renderWorldBookList() {
                const container = document.getElementById('world-book-list-container');
                const placeholder = document.getElementById('no-world-books-placeholder');
                
                container.innerHTML = '';
                placeholder.style.display = db.worldBooks.length === 0 ? 'block' : 'none';
                
                // 按优先级排序
                const sortedBooks = [...db.worldBooks].sort((a, b) => (b.priority || 5) - (a.priority || 5));
                
                sortedBooks.forEach(book => {
                    const li = document.createElement('li');
                    li.className = 'list-item world-book-item';
                    li.dataset.id = book.id;
                    li.innerHTML = `
                        <div class="item-details" style="padding-left: 20px;">
                            <div class="world-book-priority">
                                <span class="priority-badge">${book.priority || 5}</span>
                                <div class="item-name">${book.name}</div>
                            </div>
                            <div class="item-preview">${book.content}</div>
                        </div>`;
                    container.appendChild(li);
                });
            }

            // --- 聊天室功能 ---
            function setupChatRoom() {
                const sendBtn = document.getElementById('send-message-btn');
                const messageInput = document.getElementById('message-input');
                const getReplyBtn = document.getElementById('get-reply-btn');
                const messageArea = document.getElementById('message-area');
                
                sendBtn.addEventListener('click', sendMessage);
                messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !isGenerating) {
                        sendMessage();
                    }
                });
                getReplyBtn.addEventListener('click', getAiReply);
                
                messageArea.addEventListener('click', (e) => {
                    if (e.target.id === 'load-more-btn') {
                        loadMoreMessages();
                    }
                });
                
                // 设置按钮
                document.getElementById('chat-settings-btn').addEventListener('click', () => {
                    if (currentChatType === 'private') {
                        loadPrivateChatSettings(); // 每次打开都重新加载最新数据
                        document.getElementById('chat-settings-fullscreen').classList.add('open');
                    }
                });
                
                // 关闭设置按钮
                document.getElementById('close-settings-btn').addEventListener('click', () => {
                    document.getElementById('chat-settings-fullscreen').classList.remove('open');
                });
            }

            function openChatRoom(chatId, type) {
                const chat = (type === 'private') ? 
                    db.characters.find(c => c.id === chatId) : 
                    db.groups.find(g => g.id === chatId);
                
                if (!chat) return;
                
                document.getElementById('chat-room-title').textContent = 
                    (type === 'private') ? chat.remarkName : chat.name;
                
                const subtitle = document.getElementById('chat-room-subtitle');
                if (type === 'private') {
                    subtitle.style.display = 'flex';
                    document.getElementById('chat-room-status-text').textContent = chat.status || '在线';
                } else {
                    subtitle.style.display = 'none';
                }
                
                const chatRoomScreen = document.getElementById('chat-room-screen');
                chatRoomScreen.style.backgroundImage = chat.chatBg ? `url(${chat.chatBg})` : 'none';
                
                currentPage = 1;
                renderMessages(false, true);
                updateChatRoomStats(); // 更新单窗口统计
                switchScreen('chat-room-screen');
            }

            function sendMessage() {
                const input = document.getElementById('message-input');
                const text = input.value.trim();
                if (!text || isGenerating) return;
                
                const chat = (currentChatType === 'private') ? 
                    db.characters.find(c => c.id === currentChatId) : 
                    db.groups.find(g => g.id === currentChatId);
                
                const myName = (currentChatType === 'private') ? chat.myName : chat.me.nickname;
                const messageContent = `[${myName}的消息：${text}]`;
                
                const message = {
                    id: `msg_${Date.now()}`,
                    role: 'user',
                    content: messageContent,
                    parts: [{ type: 'text', text: messageContent }],
                    timestamp: Date.now()
                };
                
                if (currentChatType === 'group') {
                    message.senderId = 'user_me';
                }
                
                chat.history.push(message);
                addMessageBubble(message);
                saveData();
                renderChatList();
                input.value = '';
            }

            function addMessageBubble(message) {
                const messageArea = document.getElementById('message-area');
                const bubbleElement = createMessageBubbleElement(message);
                if (bubbleElement) {
                    messageArea.appendChild(bubbleElement);
                    messageArea.scrollTop = messageArea.scrollHeight;
                    updateChatRoomStats(); // 更新单窗口统计
                }
            }

            function loadMoreMessages() {
                currentPage++;
                renderMessages(true, false);
            }

            async function getAiReply() {
                if (isGenerating) return;
                
                const currentApi = getCurrentApiConfig();
                if (!currentApi) {
                    showToast('请先在API设置中配置API！');
                    switchScreen('api-settings-screen');
                    return;
                }
                
                const chat = (currentChatType === 'private') ? 
                    db.characters.find(c => c.id === currentChatId) : 
                    db.groups.find(g => g.id === currentChatId);
                
                if (!chat) return;
                
                isGenerating = true;
                const getReplyBtn = document.getElementById('get-reply-btn');
                const typingIndicator = document.getElementById('typing-indicator');
                
                getReplyBtn.disabled = true;
                const typingName = currentChatType === 'private' ? chat.remarkName : chat.name;
                typingIndicator.textContent = `"${typingName}"正在输入中...`;
                typingIndicator.style.display = 'block';
                
                try {
                    const systemPrompt = generateSystemPrompt(chat);
                    const historySlice = chat.history.slice(-chat.maxMemory);
                    
                    let requestBody, endpoint, headers;
                    
                    if (currentApi.provider === 'gemini') {
                        const contents = historySlice.map(msg => ({
                            role: msg.role === 'assistant' ? 'model' : 'user',
                            parts: msg.parts || [{ text: msg.content }]
                        }));
                        
                        requestBody = {
                            contents,
                            system_instruction: { parts: [{ text: systemPrompt }] },
                            generationConfig: {}
                        };
                        
                        endpoint = `${currentApi.url}/v1beta/models/${currentApi.model}:streamGenerateContent?key=${currentApi.key}`;
                        headers = { 'Content-Type': 'application/json' };
                    } else {
                        const messages = [
                            { role: 'system', content: systemPrompt },
                            ...historySlice.map(msg => ({
                                role: msg.role,
                                content: msg.parts ? msg.parts.map(p => p.text || p).join('') : msg.content
                            }))
                        ];
                        
                        requestBody = {
                            model: currentApi.model,
                            messages,
                            stream: true
                        };
                        
                        endpoint = `${currentApi.url}/v1/chat/completions`;
                        headers = {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${currentApi.key}`
                        };
                    }
                    
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers,
                        body: JSON.stringify(requestBody)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API错误: ${response.status}`);
                    }
                    
                    await processStreamResponse(response, chat, currentApi.provider);
                    
                } catch (error) {
                    console.error('AI回复失败:', error);
                    showToast(`AI回复失败: ${error.message}`);
                } finally {
                    isGenerating = false;
                    getReplyBtn.disabled = false;
                    typingIndicator.style.display = 'none';
                }
            }

            function generateSystemPrompt(chat) {
                // 这里应该根据聊天类型生成不同的系统提示
                // 简化版本，实际实现需要更完整
                const now = new Date();
                const currentTime = `${now.getFullYear()}年${pad(now.getMonth() + 1)}月${pad(now.getDate())}日 ${pad(now.getHours())}:${pad(now.getMinutes())}`;
                
                if (currentChatType === 'private') {
                    return `你正在扮演${chat.realName}，与${chat.myName}聊天。当前时间：${currentTime}。${chat.persona || ''}`;
                } else {
                    return `你在群聊"${chat.name}"中扮演多个角色。当前时间：${currentTime}。`;
                }
            }

            async function processStreamResponse(response, chat, provider) {
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullResponse = '';
                let accumulatedChunk = '';
                
                for (;;) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    accumulatedChunk += decoder.decode(value, { stream: true });
                    
                    if (provider === 'gemini') {
                        // Gemini特殊处理
                        continue;
                    } else {
                        // OpenAI格式处理
                        const parts = accumulatedChunk.split('\n\n');
                        accumulatedChunk = parts.pop();
                        
                        for (const part of parts) {
                            if (part.startsWith('data: ')) {
                                const data = part.substring(6);
                                if (data.trim() !== '[DONE]') {
                                    try {
                                        const parsed = JSON.parse(data);
                                        fullResponse += parsed.choices[0].delta?.content || '';
                                    } catch (e) {
                                        // 忽略解析错误
                                    }
                                }
                            }
                        }
                    }
                }
                
                if (provider === 'gemini') {
                    try {
                        const geminiStream = `[${accumulatedChunk.replace(/data: /g, '').replace(/\n/g, ',').slice(0, -1)}]`;
                        const parsedStream = JSON.parse(geminiStream);
                        fullResponse = parsedStream.map(item => 
                            item.candidates?.[0]?.content?.parts?.[0]?.text || ''
                        ).join('');
                    } catch (e) {
                        console.error('解析Gemini响应失败:', e);
                        showToast('解析AI响应失败');
                        return;
                    }
                }
                
                if (fullResponse) {
                    const message = {
                        id: `msg_${Date.now()}_${Math.random()}`,
                        role: 'assistant',
                        content: fullResponse,
                        parts: [{ type: 'text', text: fullResponse }],
                        timestamp: Date.now()
                    };
                    
                    chat.history.push(message);
                    addMessageBubble(message);
                    saveData();
                    renderChatList();
                }
            }

            // --- 世界书选择 ---
            function setupWorldBookSelection() {
                const saveWorldBookSelectionBtn = document.getElementById('save-world-book-selection-btn');
                const worldBookSelectionModal = document.getElementById('world-book-selection-modal');
                const worldBookSelectionList = document.getElementById('world-book-selection-list');
                
                saveWorldBookSelectionBtn.addEventListener('click', () => {
                    const selectedIds = Array.from(worldBookSelectionList.querySelectorAll('input:checked')).map(input => input.value);
                    
                    if (currentChatType === 'private') {
                        const character = db.characters.find(c => c.id === currentChatId);
                        if (character) {
                            character.worldBookIds = selectedIds;
                        }
                    } else if (currentChatType === 'group') {
                        const group = db.groups.find(g => g.id === currentChatId);
                        if (group) {
                            group.worldBookIds = selectedIds;
                        }
                    }
                    
                    saveData();
                    worldBookSelectionModal.classList.remove('visible');
                    showToast('世界书关联已更新');
                });
            }

            // --- 计算字符数 ---
            function calculateTotalChars(chat) {
                if (!chat.history) return 0;
                
                return chat.history.reduce((sum, msg) => {
                    // 提取实际文本内容，去除格式标记
                    const textMatch = msg.content.match(/\[.*?的消息：([\s\S]+?)\]/);
                    const text = textMatch ? textMatch[1] : msg.content;
                    return sum + (text?.length || 0);
                }, 0);
            }

            // --- 聊天设置 ---
            function setupChatSettings() {
                // 设置内容将在loadPrivateChatSettings中动态生成
            }

            function loadPrivateChatSettings() {
                const char = db.characters.find(c => c.id === currentChatId);
                if (!char) return;
                
                document.getElementById('settings-title').textContent = '聊天设置';
                const content = document.getElementById('settings-content');
                
                content.innerHTML = `
                    <!-- API消耗统计 -->
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0; color: var(--primary-color);">API消耗统计</h4>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>消息总数：</span>
                            <span>${char.history?.length || 0}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>总字符数：</span>
                            <span>${calculateTotalChars(char)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>记忆窗口：</span>
                            <span>${char.maxMemory || 10}</span>
                        </div>
                    </div>
                    
                    <form id="private-chat-settings-form">
                        <div class="form-group">
                            <label>角色头像</label>
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <img src="${char.avatar}" alt="角色头像" id="setting-char-avatar-preview" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary-color); cursor: pointer;">
                                <input type="file" id="setting-char-avatar-upload" accept="image/*" style="display:none;">
                                <label for="setting-char-avatar-upload" class="btn btn-primary" style="flex-grow:1;">更换角色头像</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="setting-char-remark">角色备注 (昵称)</label>
                            <input type="text" id="setting-char-remark" value="${char.remarkName}">
                        </div>
                        <div class="form-group">
                            <label for="setting-char-persona">角色人设</label>
                            <textarea id="setting-char-persona" placeholder="详细描述角色的性格、背景、说话风格等。">${char.persona || ''}</textarea>
                        </div>
                        <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                        <div class="form-group">
                            <label>我的头像</label>
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <img src="${char.myAvatar}" alt="我的头像" id="setting-my-avatar-preview" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary-color); cursor: pointer;">
                                <input type="file" id="setting-my-avatar-upload" accept="image/*" style="display:none;">
                                <label for="setting-my-avatar-upload" class="btn btn-secondary" style="flex-grow:1;">更换我的头像</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="setting-my-name">我的姓名</label>
                            <input type="text" id="setting-my-name" value="${char.myName}">
                        </div>
                        <div class="form-group">
                            <label for="setting-my-persona">我的人设</label>
                            <textarea id="setting-my-persona" placeholder="描述你希望在对话中扮演的形象。">${char.myPersona || ''}</textarea>
                        </div>
                        <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                        <div class="form-group">
                            <button type="button" class="btn btn-secondary" id="link-world-book-btn">关联世界书</button>
                        </div>
                        <div class="form-group">
                            <label for="setting-theme-color">主题颜色</label>
                            <select id="setting-theme-color">
                                ${Object.entries(colorThemes).map(([key, theme]) => 
                                    `<option value="${key}" ${(char.theme || 'white_pink') === key ? 'selected' : ''}>${theme.name}</option>`
                                ).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="setting-max-memory">最大记忆轮数</label>
                            <input type="number" id="setting-max-memory" value="${char.maxMemory || 10}" min="1">
                        </div>
                        <div class="form-group">
                            <label for="setting-chat-bg-upload" class="btn btn-primary">更换聊天背景</label>
                            <input type="file" id="setting-chat-bg-upload" accept="image/*" style="display:none;">
                        </div>
                        <button type="submit" class="btn btn-primary">保存设置</button>
                        <hr style="border:none; border-top:1px solid #eee; margin: 20px 0;">
                        <button type="button" class="btn btn-danger" id="clear-chat-history-btn">清空聊天记录</button>
                    </form>
                `;
                
                // 绑定事件
                setupPrivateChatSettingsEvents();
            }

            function setupPrivateChatSettingsEvents() {
                const form = document.getElementById('private-chat-settings-form');
                const clearBtn = document.getElementById('clear-chat-history-btn');
                const linkWorldBookBtn = document.getElementById('link-world-book-btn');
                
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    savePrivateChatSettings();
                });
                
                clearBtn.addEventListener('click', clearChatHistory);
                
                // 关联世界书
                linkWorldBookBtn.addEventListener('click', () => {
                    const character = db.characters.find(c => c.id === currentChatId);
                    if (!character) return;
                    
                    const worldBookSelectionList = document.getElementById('world-book-selection-list');
                    worldBookSelectionList.innerHTML = '';
                    
                    db.worldBooks.forEach(book => {
                        const li = document.createElement('li');
                        li.className = 'world-book-select-item';
                        const isChecked = (character.worldBookIds || []).includes(book.id);
                        li.innerHTML = `
                            <input type="checkbox" id="wb-select-${book.id}" value="${book.id}" ${isChecked ? 'checked' : ''}>
                            <label for="wb-select-${book.id}">${book.name}</label>`;
                        worldBookSelectionList.appendChild(li);
                    });
                    
                    document.getElementById('world-book-selection-modal').classList.add('visible');
                });
                
                // 头像上传
                document.getElementById('setting-char-avatar-upload').addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        try {
                            const compressed = await compressImage(file, { quality: 0.8, maxWidth: 400, maxHeight: 400 });
                            document.getElementById('setting-char-avatar-preview').src = compressed;
                        } catch (error) {
                            showToast('头像压缩失败');
                        }
                    }
                });
                
                document.getElementById('setting-my-avatar-upload').addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        try {
                            const compressed = await compressImage(file, { quality: 0.8, maxWidth: 400, maxHeight: 400 });
                            document.getElementById('setting-my-avatar-preview').src = compressed;
                        } catch (error) {
                            showToast('头像压缩失败');
                        }
                    }
                });
                
                document.getElementById('setting-chat-bg-upload').addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        try {
                            const compressed = await compressImage(file, { quality: 0.85, maxWidth: 1080, maxHeight: 1920 });
                            const char = db.characters.find(c => c.id === currentChatId);
                            if (char) {
                                char.chatBg = compressed;
                                document.getElementById('chat-room-screen').style.backgroundImage = `url(${compressed})`;
                                saveData();
                                showToast('聊天背景已更换');
                            }
                        } catch (error) {
                            showToast('背景压缩失败');
                        }
                    }
                });
            }

            function savePrivateChatSettings() {
                const char = db.characters.find(c => c.id === currentChatId);
                if (!char) return;
                
                char.avatar = document.getElementById('setting-char-avatar-preview').src;
                char.remarkName = document.getElementById('setting-char-remark').value;
                char.persona = document.getElementById('setting-char-persona').value;
                char.myAvatar = document.getElementById('setting-my-avatar-preview').src;
                char.myName = document.getElementById('setting-my-name').value;
                char.myPersona = document.getElementById('setting-my-persona').value;
                char.theme = document.getElementById('setting-theme-color').value;
                char.maxMemory = parseInt(document.getElementById('setting-max-memory').value);
                
                saveData();
                showToast('设置已保存！');
                document.getElementById('chat-room-title').textContent = char.remarkName;
                renderChatList();
                updateChatRoomStats(); // 更新聊天室统计
                document.getElementById('chat-settings-fullscreen').classList.remove('open');
            }

            function clearChatHistory() {
                const char = db.characters.find(c => c.id === currentChatId);
                if (!char) return;
                
                if (confirm(`确定要清空与"${char.remarkName}"的所有聊天记录吗？此操作不可恢复！`)) {
                    char.history = [];
                    saveData();
                    renderMessages(false, true);
                    renderChatList();
                    updateChatRoomStats(); // 更新单窗口统计
                    document.getElementById('chat-settings-fullscreen').classList.remove('open');
                    showToast('聊天记录已清空');
                }
            }

            // --- 上下文菜单 ---
            function createContextMenu(items, x, y) {
                removeContextMenu();
                const menu = document.createElement('div');
                menu.className = 'context-menu';
                menu.style.left = `${x}px`;
                menu.style.top = `${y}px`;
                
                items.forEach(item => {
                    const menuItem = document.createElement('div');
                    menuItem.className = 'context-menu-item';
                    if (item.danger) menuItem.classList.add('danger');
                    menuItem.textContent = item.label;
                    menuItem.onclick = () => {
                        item.action();
                        removeContextMenu();
                    };
                    menu.appendChild(menuItem);
                });
                
                document.body.appendChild(menu);
                document.addEventListener('click', removeContextMenu, { once: true });
            }

            function removeContextMenu() {
                const menu = document.querySelector('.context-menu');
                if (menu) menu.remove();
            }

            // --- 角色创建 ---
            function setupCharacterCreation() {
                const addChatBtn = document.getElementById('add-chat-btn');
                const addCharModal = document.getElementById('add-char-modal');
                const addCharForm = document.getElementById('add-char-form');
                
                addChatBtn.addEventListener('click', () => {
                    addCharForm.reset();
                    addCharModal.classList.add('visible');
                });
                
                addCharForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    
                    const newChar = {
                        id: `char_${Date.now()}`,
                        realName: document.getElementById('char-real-name').value,
                        remarkName: document.getElementById('char-remark-name').value,
                        persona: '',
                        avatar: 'https://i.postimg.cc/Y96LPskq/o-o-2.jpg',
                        myName: document.getElementById('my-name-for-char').value,
                        myPersona: '',
                        myAvatar: 'https://i.postimg.cc/GtbTnxhP/o-o-1.jpg',
                        theme: 'white_pink',
                        maxMemory: 10,
                        chatBg: '',
                        history: [],
                        isPinned: false,
                        status: '在线',
                        worldBookIds: [],
                        useCustomBubbleCss: false,
                        customBubbleCss: ''
                    };
                    
                    db.characters.push(newChar);
                    saveData();
                    renderChatList();
                    addCharModal.classList.remove('visible');
                    showToast(`角色"${newChar.remarkName}"创建成功！`);
                });
            }

            // 启动应用
            init();
            setupCharacterCreation();
        });
    </script>
</body>
</html>